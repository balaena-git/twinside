<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>üí∞ –§–∏–Ω–∞–Ω—Å—ã ‚Äî TwinSide Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="../assets/admin.css" />
  <style>
    main { padding: 20px; }
    .tabs { display:flex; gap:10px; margin-bottom:20px; }
    .tabs button {
      background:#141418; color:#fff; border:1px solid #7F3DF4;
      border-radius:8px; padding:10px 18px; cursor:pointer;
    }
    .tabs button.active { background:#7F3DF4; color:#fff; }
    table { width:100%; border-collapse:collapse; margin-top:10px; }
    th,td {
      padding:10px; border-bottom:1px solid rgba(255,255,255,.1);
      text-align:left; font-size:14px; color:#eaeaea;
    }
    th { color:#F2C94C; font-weight:600; }
    .form-row { margin:15px 0; display:flex; gap:10px; align-items:center; }
    .form-row input, .form-row textarea {
      background:#141418; color:#fff; border:none; border-radius:6px;
      padding:8px 10px; flex:1;
    }
    .btn { background:#7F3DF4; color:#fff; border:none;
      border-radius:6px; padding:8px 14px; cursor:pointer;
    }
    .btn.gold { background:#F2C94C; color:#000; font-weight:600; }
  </style>
</head>
<body>
<header>
  <h1>üí∞ –§–∏–Ω–∞–Ω—Å—ã</h1>
  <nav class="admin-nav">
    <a href="/admin/admin.html">üè† –î–∞—à–±–æ—Ä–¥</a>
    <a href="/admin/admin-pending.html">–ê–Ω–∫–µ—Ç—ã</a>
    <a href="/admin/admin-users.html">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</a>
    <a class="active" href="/admin/admin-finance.html">–§–∏–Ω–∞–Ω—Å—ã</a>
    <a href="/admin/admin-promos.html">–ü—Ä–æ–º–æ–∫–æ–¥—ã</a>
    <a href="/admin/admin-support.html">–ü–æ–¥–¥–µ—Ä–∂–∫–∞</a>
    <a href="/admin/admin-ads.html">–†–µ–∫–ª–∞–º–∞</a>
  </nav>
  <button id="logout" class="btn">–í—ã–π—Ç–∏</button>
</header>

<main>
    <section id="finance-stats" class="finance-stats">
  <h2>üìà –§–∏–Ω–∞–Ω—Å–æ–≤–∞—è —Å–≤–æ–¥–∫–∞</h2>
  <div id="stats-grid" class="stats-grid">
    <div class="stat-card">
      <h3>üí∞ –û–±—â–∏–π –±–∞–ª–∞–Ω—Å</h3><p id="stat-balance">‚Äî</p>
    </div>
    <div class="stat-card">
      <h3>üßæ –í—Å–µ–≥–æ –≤—ã–≤–æ–¥–æ–≤</h3><p id="stat-withdrawn">‚Äî</p>
    </div>
    <div class="stat-card">
      <h3>‚è≥ –û–∂–∏–¥–∞–µ—Ç –≤—ã–≤–æ–¥</h3><p id="stat-pending">‚Äî</p>
    </div>
    <div class="stat-card">
      <h3>üëë –ü—Ä–µ–º–∏—É–º–æ–≤</h3><p id="stat-premium">‚Äî</p>
    </div>
    <div class="stat-card">
      <h3>üìä –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–π</h3><p id="stat-tx">‚Äî</p>
    </div>
    <div class="stat-card">
      <h3>üí∏ –î–æ—Ö–æ–¥ 24—á</h3><p id="stat-income">‚Äî</p>
    </div>
  </div>
</section>


  <div class="tabs">
    <button class="active" data-tab="withdraws">ü™ô –í—ã–≤–æ–¥—ã</button>
    <button data-tab="manual">üíµ –ù–∞—á–∏—Å–ª–µ–Ω–∏—è</button>
    <button data-tab="premium">üëë –ü—Ä–µ–º–∏—É–º</button>
    <button data-tab="history">üìä –ò—Å—Ç–æ—Ä–∏—è</button>
  </div>

  <!-- –í—ã–≤–æ–¥—ã -->
  <section id="withdraws" class="tab-content">
    <h2>ü™ô –ó–∞—è–≤–∫–∏ –Ω–∞ –≤—ã–≤–æ–¥</h2>
    <table id="withdraw-table">
      <thead>
        <tr><th>ID</th><th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th><th>–°—É–º–º–∞</th><th>–°—Ç–∞—Ç—É—Å</th><th>TX Hash</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr>
      </thead>
      <tbody><tr><td colspan="6" style="text-align:center;color:#999;">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr></tbody>
    </table>
  </section>

  <!-- –†—É—á–Ω—ã–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è -->
  <section id="manual" class="tab-content" style="display:none;">
    <h2>üíµ –†—É—á–Ω–æ–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ</h2>
    <div class="form-row"><input id="manual-email" type="email" placeholder="Email –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"></div>
    <div class="form-row"><input id="manual-amount" type="number" placeholder="–°—É–º–º–∞"></div>
    <div class="form-row"><textarea id="manual-desc" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π"></textarea></div>
    <button class="btn gold" onclick="manualCredit()">–ù–∞—á–∏—Å–ª–∏—Ç—å üí∏</button>
  </section>

  <!-- –ü—Ä–µ–º–∏—É–º -->
  <section id="premium" class="tab-content" style="display:none;">
    <h2>üëë –í—ã–¥–∞—Ç—å –ø—Ä–µ–º–∏—É–º</h2>
    <div class="form-row"><input id="premium-id" type="number" placeholder="ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"></div>
    <div class="form-row"><input id="premium-days" type="number" value="30" placeholder="–î–Ω–µ–π –ø—Ä–µ–º–∏—É–º–∞"></div>
    <button class="btn gold" onclick="givePremium()">–í—ã–¥–∞—Ç—å üëë</button>
  </section>

  <!-- –ò—Å—Ç–æ—Ä–∏—è -->
  <section id="history" class="tab-content" style="display:none;">
    <h2>üìä –ò—Å—Ç–æ—Ä–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π</h2>
    <table id="tx-table">
      <thead><tr><th>ID</th><th>Email</th><th>–¢–∏–ø</th><th>–°—É–º–º–∞</th><th>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th><th>–î–∞—Ç–∞</th></tr></thead>
      <tbody><tr><td colspan="6" style="text-align:center;color:#999;">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr></tbody>
    </table>
  </section>
</main>

<footer>¬© TwinSide Admin 2025</footer>

<script>
const API = "http://localhost:3000/api/admin";

// === Tabs ===
document.querySelectorAll(".tabs button").forEach(btn => {
  btn.onclick = () => {
    document.querySelectorAll(".tabs button").forEach(b => b.classList.remove("active"));
    btn.classList.add("active");
    document.querySelectorAll(".tab-content").forEach(sec => sec.style.display = "none");
    document.getElementById(btn.dataset.tab).style.display = "block";
    if (btn.dataset.tab === "withdraws") loadWithdraws();
    if (btn.dataset.tab === "history") loadTransactions();
  };
});

// === Logout ===
document.getElementById("logout").onclick = async () => {
  await fetch(`${API}/logout`, { method: "POST", credentials: "include" });
  location.href = "/admin/admin.html";
};

// === Load Withdraws ===
async function loadWithdraws() {
  const tbody = document.querySelector("#withdraw-table tbody");
  tbody.innerHTML = "<tr><td colspan='6' style='text-align:center;color:#999;'>–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>";
  const res = await fetch(`${API}/withdraws`, { credentials: "include" });
  const data = await res.json();
  if (!data.ok || !data.withdraws.length)
    return tbody.innerHTML = "<tr><td colspan='6' style='text-align:center;color:#999;'>–ù–µ—Ç –∑–∞—è–≤–æ–∫</td></tr>";

  tbody.innerHTML = "";
  data.withdraws.forEach(w => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${w.id}</td>
      <td>${w.nick || w.email}</td>
      <td>${w.amount}</td>
      <td>${w.status}</td>
      <td>${w.tx_hash || "‚Äî"}</td>
      <td>
        ${w.status === "pending" ? `
          <button class="btn gold" onclick="approveWithdraw(${w.id})">‚úÖ</button>
          <button class="btn" onclick="rejectWithdraw(${w.id})">‚ùå</button>` : "‚Äî"}
      </td>`;
    tbody.appendChild(tr);
  });
}

// === Approve / Reject Withdraw ===
async function approveWithdraw(id) {
  const hash = prompt("–í–≤–µ–¥–∏—Ç–µ TX hash:");
  if (!hash) return;
  await fetch(`${API}/withdraw/${id}`, {
    method: "PATCH",
    headers: {"Content-Type":"application/json"},
    credentials: "include",
    body: JSON.stringify({ tx_hash: hash })
  });
  loadWithdraws();
}

async function rejectWithdraw(id) {
  const reason = prompt("–ü—Ä–∏—á–∏–Ω–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è:");
  if (!reason) return;
  await fetch(`${API}/withdraw/${id}`, {
    method: "PATCH",
    headers: {"Content-Type":"application/json"},
    credentials: "include",
    body: JSON.stringify({ reject:true, reason })
  });
  loadWithdraws();
}

// === Manual Credit ===
async function manualCredit() {
  const email = document.getElementById("manual-email").value.trim();
  const amount = parseInt(document.getElementById("manual-amount").value);
  const desc = document.getElementById("manual-desc").value.trim();
  if (!email || !amount) return alert("–í–≤–µ–¥–∏—Ç–µ email –∏ —Å—É–º–º—É!");
  const res = await fetch(`${API}/manual-credit`, {
    method:"POST", headers:{"Content-Type":"application/json"}, credentials:"include",
    body:JSON.stringify({ email, amount, description: desc })
  });
  const data = await res.json();
  alert(data.ok ? "‚úÖ –ë–∞–ª–∞–Ω—Å –ø–æ–ø–æ–ª–Ω–µ–Ω!" : "–û—à–∏–±–∫–∞: " + data.error);
}

// === Premium ===
async function givePremium() {
  const id = parseInt(document.getElementById("premium-id").value);
  const days = parseInt(document.getElementById("premium-days").value);
  if (!id) return alert("–í–≤–µ–¥–∏—Ç–µ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è!");
  const res = await fetch(`${API}/premium`, {
    method:"POST", headers:{"Content-Type":"application/json"}, credentials:"include",
    body:JSON.stringify({ user_id:id, days })
  });
  const data = await res.json();
  alert(data.ok ? "üëë –ü—Ä–µ–º–∏—É–º –≤—ã–¥–∞–Ω –¥–æ " + new Date(data.until).toLocaleDateString() : "–û—à–∏–±–∫–∞");
}

// === Load Transactions ===
async function loadTransactions() {
  const tbody = document.querySelector("#tx-table tbody");
  tbody.innerHTML = "<tr><td colspan='6' style='text-align:center;color:#999;'>–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>";
  const res = await fetch(`${API}/transactions`, { credentials:"include" });
  const data = await res.json();
  if (!data.ok || !data.list?.length)
    return tbody.innerHTML = "<tr><td colspan='6' style='text-align:center;color:#999;'>–ù–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π</td></tr>";

  tbody.innerHTML = "";
  data.list.forEach(t => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${t.id}</td>
      <td>${t.email || t.user_id}</td>
      <td>${t.type}</td>
      <td>${t.amount}</td>
      <td>${t.description || "‚Äî"}</td>
      <td>${new Date(t.created_at).toLocaleString("ru-RU")}</td>`;
    tbody.appendChild(tr);
  });
}

// ‚Äî –∞–≤—Ç–æ-–∑–∞–≥—Ä—É–∑–∫–∞
loadWithdraws();
</script>
</body>
</html>
