<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>üßæ –ú–æ–¥–µ—Ä–∞—Ü–∏—è –∞–Ω–∫–µ—Ç ‚Äî TwinSide Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="../assets/admin.css">
  <style>
    main{padding:20px;}
    .pending-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(280px,1fr));
      gap:20px;margin-top:20px;
    }
    .pending-card{
      background:#1c1c22;border-radius:12px;padding:16px;
      box-shadow:0 0 15px rgba(127,61,244,.25);
      display:flex;flex-direction:column;align-items:center;text-align:center;
      transition:.3s;
    }
    .pending-card:hover{transform:translateY(-3px);box-shadow:0 0 25px rgba(242,201,76,.3);}
    .pending-card img{
      width:130px;height:130px;object-fit:cover;border-radius:50%;
      border:2px solid #7F3DF4;cursor:pointer;margin-bottom:10px;transition:.3s;
    }
    .pending-card img:hover{transform:scale(1.05);}
    .pending-card h3{color:#F2C94C;margin:6px 0;}
    .pending-card .meta{color:#CFCFE2;font-size:13px;margin-bottom:6px;}
    .pending-card .about{font-size:14px;color:#ddd;margin:8px 0;}
    .pending-card .actions{display:flex;gap:10px;margin-top:10px;}
    .pending-card .btn{padding:8px 14px;font-size:13px;}
    .pagination{display:flex;justify-content:center;align-items:center;gap:10px;margin-top:30px;}
    .pagination span{color:#CFCFE2;}
    /* –º–æ–¥–∞–ª–∫–∞ */
    #photoModal{position:fixed;inset:0;background:rgba(0,0,0,.85);
      display:none;align-items:center;justify-content:center;z-index:1000;}
    #photoModal img{max-width:92%;max-height:92%;border:3px solid #7F3DF4;border-radius:10px;
      box-shadow:0 0 40px rgba(127,61,244,.6);}
    #photoModal .close{position:absolute;top:20px;right:24px;font-size:26px;color:#fff;cursor:pointer}
  </style>
</head>
<body>
  <header>
    <h1>üßæ –ú–æ–¥–µ—Ä–∞—Ü–∏—è –∞–Ω–∫–µ—Ç</h1>
    <nav class="admin-nav">
      <a href="/admin/admin.html">üè† –î–∞—à–±–æ—Ä–¥</a>
      <a class="active" href="/admin/admin-pending.html">–ê–Ω–∫–µ—Ç—ã</a>
      <a href="/admin/admin-users.html">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</a>
      <a href="/admin/admin-finance.html">–§–∏–Ω–∞–Ω—Å—ã</a>
      <a href="/admin/admin-promos.html">–ü—Ä–æ–º–æ–∫–æ–¥—ã</a>
      <a href="/admin/admin-support.html">–ü–æ–¥–¥–µ—Ä–∂–∫–∞</a>
      <a href="/admin/admin-ads.html">–†–µ–∫–ª–∞–º–∞</a>
    </nav>
    <button id="logout" class="btn">–í—ã–π—Ç–∏</button>
  </header>

  <main>
    <h2>üìã –ê–Ω–∫–µ—Ç—ã, –æ–∂–∏–¥–∞—é—â–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏</h2>
    <div id="pending-list" class="pending-grid"><p>–ó–∞–≥—Ä—É–∑–∫–∞...</p></div>

    <div class="pagination">
      <button id="prev" class="btn gold">‚Üê –ù–∞–∑–∞–¥</button>
      <span id="page-info">–°—Ç—Ä–∞–Ω–∏—Ü–∞ 1</span>
      <button id="next" class="btn gold">–í–ø–µ—Ä—ë–¥ ‚Üí</button>
    </div>
  </main>

  <footer>¬© TwinSide Admin 2025</footer>

  <!-- –ú–æ–¥–∞–ª–∫–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ñ–æ—Ç–æ -->
  <div id="photoModal" onclick="closePhoto()">
    <span class="close">‚úï</span>
    <img id="modalImg" src="" alt="–ü—Ä–æ—Å–º–æ—Ç—Ä —Ñ–æ—Ç–æ">
  </div>

  <script>
    // üëá –µ—Å–ª–∏ –±–µ–∫–µ–Ω–¥ –Ω–∞ –¥—Ä—É–≥–æ–º –ø–æ—Ä—Ç—É/–¥–æ–º–µ–Ω–µ ‚Äî –ø—Ä–∞–≤–∏–º —Ç—É—Ç –æ–¥–∏–Ω —Ä–∞–∑
    const BACKEND = "http://localhost:3000";
    const API = BACKEND + "/api/admin";

    let currentPage = 1;
    const limit = 6;

    // –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –ø—É—Ç–µ–π: –ø—Ä–∏–Ω–∏–º–∞–µ—Ç —Ç–æ, —á—Ç–æ –ø—Ä–∏—à–ª–æ –∏–∑ –ë–î, –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–æ–ª–Ω—ã–π URL
    function toFileUrl(p) {
      if (!p) return null;
      // —É–∂–µ –ø–æ–ª–Ω—ã–π http(s) ‚Äî –æ—Å—Ç–∞–≤–ª—è–µ–º
      if (/^https?:\/\//i.test(p)) return p;
      // –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å /uploads –∏–ª–∏ uploads ‚Äî –ø—Ä–µ—Ñ–∏–∫—Å—É–µ–º –±–µ–∫–µ–Ω–¥–æ–º
      if (p.startsWith("/uploads")) return BACKEND + p;
      if (p.startsWith("uploads")) return BACKEND + "/" + p;
      // –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π ‚Äî —Å—á–∏—Ç–∞–µ–º, —á—Ç–æ —ç—Ç–æ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π —Ñ–∞–π–ª –≤–Ω—É—Ç—Ä–∏ /uploads
      return BACKEND + "/uploads/" + p.replace(/^\/+/, "");
    }

    async function loadPending(page = 1) {
      const container = document.getElementById("pending-list");
      container.innerHTML = "<p>–ó–∞–≥—Ä—É–∑–∫–∞...</p>";

      try {
        const res = await fetch(`${API}/pending?page=${page}&limit=${limit}`, { credentials: "include" });
        const data = await res.json();

        if (!data.ok || !data.users?.length) {
          container.innerHTML = "<p style='color:#aaa;'>–ù–µ—Ç –∞–Ω–∫–µ—Ç –¥–ª—è –º–æ–¥–µ—Ä–∞—Ü–∏–∏.</p>";
          document.getElementById("page-info").textContent = "–°—Ç—Ä–∞–Ω–∏—Ü–∞ 1 –∏–∑ 1";
          return;
        }

        container.innerHTML = "";
        document.getElementById("page-info").textContent = `–°—Ç—Ä–∞–Ω–∏—Ü–∞ ${data.page} –∏–∑ ${data.pages}`;

        data.users.forEach(u => {
          const created = new Date(u.created_at).toLocaleString("ru-RU");
          const avatarUrl = toFileUrl(u.avatar_path) || "/assets/icons/user.svg";
          const verifyUrl = toFileUrl(u.verify_path);

          const card = document.createElement("div");
          card.className = "pending-card";
          card.innerHTML = `
            <img src="${avatarUrl}"
                 alt="avatar"
                 onclick="openPhoto('${avatarUrl}')"
                 onerror="this.onerror=null;this.src='/assets/icons/user.svg'">
            <div class="info">
              <h3>${u.nick}</h3>
              <p class="meta">${u.city || "–ì–æ—Ä–æ–¥ –Ω–µ —É–∫–∞–∑–∞–Ω"} ¬∑ ${u.gender || "‚Äî"}</p>
              <p class="meta" style="opacity:.8">${u.email}</p>
              <p class="about">${u.about ? escapeHtml(u.about) : "–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è"}</p>
              <p class="meta">üìÖ –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω: ${created}</p>
              ${verifyUrl ? `<button class="btn gold" onclick="openPhoto('${verifyUrl}')">üì∏ –§–æ—Ç–æ —Å –ª–∏—Å—Ç–∏–∫–æ–º</button>` : ""}
            </div>
            <div class="actions">
              <button class="btn gold" onclick="approveUser(${u.id})">–û–¥–æ–±—Ä–∏—Ç—å</button>
              <button class="btn" onclick="rejectUser(${u.id})">–û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
            </div>
          `;
          container.appendChild(card);
        });
      } catch (e) {
        container.innerHTML = `<p style='color:red;'>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${e.message}</p>`;
      }
    }

    function openPhoto(url) {
      const m = document.getElementById("photoModal");
      const img = document.getElementById("modalImg");
      img.src = url;
      m.style.display = "flex";
    }
    function closePhoto() {
      const m = document.getElementById("photoModal");
      const img = document.getElementById("modalImg");
      img.src = "";
      m.style.display = "none";
    }
    function escapeHtml(s){
      return s.replace(/[&<>"'`=\/]/g, c => ({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','/':'&#x2F;','`':'&#x60;','=':'&#x3D;'
      }[c]));
    }

    async function approveUser(id) {
      if (!confirm("–û–¥–æ–±—Ä–∏—Ç—å –∞–Ω–∫–µ—Ç—É?")) return;
      const res = await fetch(`${API}/approve/${id}`, { method: "POST", credentials: "include" });
      const data = await res.json();
      if (data.ok) loadPending(currentPage);
      else alert("–û—à–∏–±–∫–∞: " + (data.error || "–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è"));
    }

    async function rejectUser(id) {
      const reason = prompt("–í–≤–µ–¥–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è:");
      if (!reason) return;
      const res = await fetch(`${API}/reject/${id}`, {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        credentials: "include",
        body: JSON.stringify({ reason })
      });
      const data = await res.json();
      if (data.ok) loadPending(currentPage);
      else alert("–û—à–∏–±–∫–∞: " + (data.error || "–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è"));
    }

    document.getElementById("logout").onclick = async () => {
      await fetch(`${API}/logout`, { method: "POST", credentials: "include" });
      location.href = "/admin/admin.html";
    };

    document.getElementById("prev").onclick = () => {
      if (currentPage > 1) {
        currentPage--;
        loadPending(currentPage);
      }
    };
    document.getElementById("next").onclick = () => {
      currentPage++;
      loadPending(currentPage);
    };

    loadPending(currentPage);
  </script>
</body>
</html>
