<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>üí¨ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ ‚Äî TwinSide Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- –æ–±—â–∏–π —Å—Ç–∏–ª—å –∞–¥–º–∏–Ω–∫–∏ -->
  <link rel="stylesheet" href="../assets/admin.css" />
  <style>
    /* ====== –ª–æ–∫–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø–æ–¥–¥–µ—Ä–∂–∫–∏ (–º–∏–Ω–∏–º—É–º, –æ—Å—Ç–∞–ª—å–Ω–æ–µ ‚Äî –≤ admin.css) ====== */
    :root{
      --bg:#0B0B0D; --panel:#141418; --ink:#fff; --muted:#CFCFE2;
      --gold:#F2C94C; --violet:#7F3DF4; --line:rgba(255,255,255,.08);
    }
    body{ background:var(--bg); color:var(--ink); }

    .support-layout{
      display:grid;
      grid-template-columns: 340px 1fr;
      gap:18px;
      padding:20px;
      max-width:1400px;
      margin:0 auto;
      width:100%;
    }
    @media (max-width: 1024px){
      .support-layout{ grid-template-columns:1fr; }
    }

    /* Sidebar (threads) */
    .threads-panel{
      background:var(--panel);
      border-radius:14px;
      box-shadow:0 0 18px rgba(127,61,244,.25);
      display:flex;
      flex-direction:column;
      min-height:72vh;
      overflow:hidden;
    }
    .threads-header{
      padding:14px 14px 8px;
      border-bottom:1px solid var(--line);
    }
    .search-row{
      display:flex;gap:8px;margin-top:10px;
    }
    .search-row input, .search-row select{
      flex:1;
      background:#0f0f13;
      border:1px solid #1f1f26;
      color:#fff;border-radius:10px;padding:10px 12px;
    }
    .search-row button{ white-space:nowrap; }

    .threads-list{
      overflow:auto;
    }
    .thread{
      display:grid;
      grid-template-columns:48px 1fr auto;
      gap:10px;
      padding:12px 14px;
      border-bottom:1px solid var(--line);
      cursor:pointer;
      transition:.20s;
    }
    .thread:hover{ background:rgba(127,61,244,.08); }
    .thread.active{ background:rgba(127,61,244,.15); }
    .thread .ava{
      width:48px;height:48px;border-radius:50%;object-fit:cover;border:2px solid var(--violet);
      background:#0f0f13;
    }
    .thread .meta h4{ margin:0; font-size:15px; color:var(--ink); }
    .thread .meta p{ margin:3px 0 0; font-size:12px; color:var(--muted); overflow:hidden; text-overflow:ellipsis; white-space:nowrap;}
    .thread .badges{ display:flex; gap:6px; align-items:center; }
    .badge{
      font-size:11px; padding:2px 8px; border-radius:999px; border:1px solid var(--line); color:#ddd;
    }
    .badge.gold{ color:#0B0B0D;background:var(--gold); border:none; }
    .badge.pin{ color:var(--gold); border-color:var(--gold); }
    .no-threads{
      padding:20px; text-align:center; color:#aaa;
    }

    /* Chat panel */
    .chat-panel{
      background:linear-gradient(160deg, rgba(255,255,255,.02), rgba(127,61,244,.06));
      border:1px solid var(--line);
      border-radius:14px;
      box-shadow:0 0 22px rgba(127,61,244,.20);
      min-height:72vh;
      display:grid;
      grid-template-rows:auto 1fr auto;
      overflow:hidden;
    }
    .chat-header{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:14px 16px; border-bottom:1px solid var(--line);
      background:rgba(0,0,0,.25);
      backdrop-filter: blur(6px);
    }
    .chat-title{
      display:flex; align-items:center; gap:12px;
    }
    .chat-title img{
      width:42px;height:42px;border-radius:50%;object-fit:cover;border:2px solid var(--violet);
      background:#0f0f13;
    }
    .chat-title .who{ display:flex;flex-direction:column;line-height:1.15; }
    .chat-title b{ color:var(--gold); }
    .chat-actions{
      display:flex; gap:8px; flex-wrap:wrap;
    }

    .chat-body{
      display:grid; grid-template-columns: 1fr 300px; gap:16px; padding:16px;
    }
    @media (max-width: 1200px){
      .chat-body{ grid-template-columns:1fr; }
    }
    .messages{
      background:#0f0f13; border:1px solid #1f1f26; border-radius:12px; padding:12px;
      overflow:auto; min-height:300px; max-height:60vh;
    }
    .msg{
      display:flex; gap:10px; margin:10px 0;
      align-items:flex-end;
    }
    .msg.me{ flex-direction:row-reverse; }
    .msg .bubble{
      max-width:68%;
      padding:10px 12px; border-radius:12px;
      background:#1b1b22; color:#fff; border:1px solid #242432;
    }
    .msg.me .bubble{ background:#251b38; border-color:#3a2b58; }
    .msg time{ font-size:11px; color:#aaa; margin:0 6px; }
    .bubble img{
      max-width:260px; max-height:260px; border-radius:10px; border:1px solid #2a2a36; display:block;
      cursor:pointer;
    }
    .bubble .file{
      display:flex; align-items:center; gap:8px; padding:8px; border:1px dashed #38384c; border-radius:10px;
      font-size:13px; color:#ddd;
    }
    .bubble .file a{ color:#fff; text-decoration:none; }
    .typing{ color:#CFCFE2; font-size:12px; margin:6px 2px; }

    .info-panel{
      background:#0f0f13; border:1px solid #1f1f26; border-radius:12px; padding:12px; min-height:200px;
    }
    .info-row{ display:flex; justify-content:space-between; gap:8px; padding:8px 0; border-bottom:1px dashed #242432; }
    .info-row:last-child{ border-bottom:none; }
    .info-row span{ color:#CFCFE2; font-size:13px; }
    .info-row b{ color:#fff; }

    .quick-replies{
      display:flex; gap:8px; flex-wrap:wrap; margin-top:10px;
    }
    .quick-replies button{ font-size:12px; }

    .chat-input{
      display:grid; grid-template-columns:auto 1fr auto; gap:10px; padding:12px; border-top:1px solid var(--line);
      background:rgba(0,0,0,.3); backdrop-filter: blur(6px);
    }
    .chat-input textarea{
      width:100%; min-height:44px; max-height:120px; resize:vertical;
      background:#0f0f13; color:#fff; border:1px solid #1f1f26; border-radius:10px; padding:10px 12px;
    }
    .icon-btn{
      background:#0f0f13; border:1px solid #1f1f26; color:#fff; border-radius:10px; padding:10px 12px; cursor:pointer;
    }

    /* –º–æ–¥–∞–ª–∫–∞ –¥–ª—è —Ñ–æ—Ç–æ */
    .modal{
      position:fixed; inset:0; background:rgba(0,0,0,.86); display:none; align-items:center; justify-content:center; z-index:1000;
    }
    .modal img{ max-width:92%; max-height:92%; border:3px solid var(--violet); border-radius:10px; box-shadow:0 0 40px rgba(127,61,244,.5); }
  </style>
</head>
<body>
  <header class="admin-header">
    <h1>üí¨ –ü–æ–¥–¥–µ—Ä–∂–∫–∞</h1>
    <nav class="admin-nav">
      <a href="/admin/admin.html">üè† –î–∞—à–±–æ—Ä–¥</a>
      <a href="/admin/admin-pending.html">–ê–Ω–∫–µ—Ç—ã</a>
      <a href="/admin/admin-users.html">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</a>
      <a href="/admin/admin-finance.html">–§–∏–Ω–∞–Ω—Å—ã</a>
      <a href="/admin/admin-promos.html">–ü—Ä–æ–º–æ–∫–æ–¥—ã</a>
      <a class="active" href="/admin/admin-support.html">–ü–æ–¥–¥–µ—Ä–∂–∫–∞</a>
      <a href="/admin/admin-ads.html">–†–µ–∫–ª–∞–º–∞</a>
    </nav>
    <button id="logout" class="btn violet">–í—ã–π—Ç–∏</button>
  </header>

  <main>
    <div class="support-layout">
      <!-- LEFT: threads -->
      <aside class="threads-panel">
        <div class="threads-header">
          <div style="display:flex; justify-content:space-between; align-items:center;">
            <h3 style="margin:0;color:var(--gold);">–î–∏–∞–ª–æ–≥–∏</h3>
            <select id="statusFilter" style="width:140px;">
              <option value="active">–ê–∫—Ç–∏–≤–Ω—ã–µ</option>
              <option value="unread">–ù–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ</option>
              <option value="resolved">–†–µ—à—ë–Ω–Ω—ã–µ</option>
              <option value="all">–í—Å–µ</option>
            </select>
          </div>
          <div class="search-row">
            <input id="searchBox" type="text" placeholder="–ù–∏–∫ / email / ID..." />
            <button class="btn gold" id="searchBtn">–ü–æ–∏—Å–∫</button>
          </div>
        </div>
        <div id="threads" class="threads-list">
          <div class="no-threads">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∏–∞–ª–æ–≥–æ–≤...</div>
        </div>
      </aside>

      <!-- RIGHT: chat -->
      <section class="chat-panel">
        <div class="chat-header">
          <div class="chat-title">
            
            <div class="who">
              <b id="chatNick">–í—ã–±–µ—Ä–∏—Ç–µ –¥–∏–∞–ª–æ–≥</b>
              <span id="chatMeta" style="color:var(--muted);font-size:12px;">‚Äî</span>
            </div>
          </div>
          <div class="chat-actions">
            <button class="btn" id="pinBtn">üìå –ó–∞–∫—Ä–µ–ø–∏—Ç—å</button>
            <button class="btn" id="resolveBtn">‚úÖ –†–µ—à–µ–Ω–æ</button>
            <button class="btn" id="openUserBtn">üë§ –ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</button>
          </div>
        </div>

        <div class="chat-body">
          <div class="messages" id="messages">
            <div class="no-threads" style="padding:16px;">–í—ã–±–µ—Ä–∏—Ç–µ –¥–∏–∞–ª–æ–≥ —Å–ª–µ–≤–∞, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å</div>
          </div>

          <aside class="info-panel">
            <h4 style="margin:6px 0 10px;color:var(--gold);">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h4>
            <div class="info-row"><span>ID</span> <b id="u_id">‚Äî</b></div>
            <div class="info-row"><span>–ù–∏–∫</span> <b id="u_nick">‚Äî</b></div>
            <div class="info-row"><span>Email</span> <b id="u_email">‚Äî</b></div>
            <div class="info-row"><span>–°—Ç–∞—Ç—É—Å</span> <b id="u_status">‚Äî</b></div>
            <div class="info-row"><span>–ë–∞–ª–∞–Ω—Å</span> <b id="u_balance">‚Äî</b></div>
            <div class="info-row"><span>–ì–æ—Ä–æ–¥</span> <b id="u_city">‚Äî</b></div>
            <div class="info-row"><span>–ü—Ä–µ–º–∏—É–º</span> <b id="u_premium">‚Äî</b></div>

            <div class="quick-replies" id="quickReplies" style="margin-top:12px;">
              <button class="btn">–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?</button>
              <button class="btn">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É—Ç–æ—á–Ω–∏—Ç–µ –≤–∞—à –≤–æ–ø—Ä–æ—Å.</button>
              <button class="btn">–ú—ã –ø—Ä–æ–≤–µ—Ä–∏–º –∏ –≤–µ—Ä–Ω—ë–º—Å—è —Å –æ—Ç–≤–µ—Ç–æ–º.</button>
            </div>
          </aside>
        </div>

        <div class="chat-input">
          <label class="icon-btn" for="filePicker">üìé</label>
          <input id="filePicker" type="file" style="display:none" />
          <textarea id="msgInput" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –æ—Ç–≤–µ—Ç..."></textarea>
          <button class="btn gold" id="sendBtn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </div>
      </section>
    </div>
  </main>

  <footer>¬© TwinSide Admin 2025</footer>

  <!-- modal preview -->
  <div id="imgModal" class="modal" onclick="this.style.display='none'">
    <img id="imgModalPic" src="" alt="preview" />
  </div>

  <script>
    const API = "http://localhost:3000/api/admin/support"; // üëà –ü–æ–º–µ–Ω—è–π –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
    const threadsBox = document.getElementById("threads");
    const searchBox = document.getElementById("searchBox");
    const statusFilter = document.getElementById("statusFilter");
    const messagesBox = document.getElementById("messages");
    const msgInput = document.getElementById("msgInput");
    const sendBtn = document.getElementById("sendBtn");
    const filePicker = document.getElementById("filePicker");

    const chatNick = document.getElementById("chatNick");
    const chatMeta = document.getElementById("chatMeta");
    const chatAva  = document.getElementById("chatAva");

    const u_id = document.getElementById("u_id");
    const u_nick = document.getElementById("u_nick");
    const u_email = document.getElementById("u_email");
    const u_status = document.getElementById("u_status");
    const u_balance = document.getElementById("u_balance");
    const u_city = document.getElementById("u_city");
    const u_premium = document.getElementById("u_premium");

    const pinBtn = document.getElementById("pinBtn");
    const resolveBtn = document.getElementById("resolveBtn");
    const openUserBtn = document.getElementById("openUserBtn");

    const imgModal = document.getElementById("imgModal");
    const imgModalPic = document.getElementById("imgModalPic");

    let selectedThread = null;
    let pollTimer = null;

    // ===== HEADER =====
    document.getElementById("logout").onclick = async () => {
      await fetch("/api/admin/logout", { method:"POST", credentials:"include" });
      location.href = "/admin/admin.html";
    };

    // ===== Threads load =====
    async function loadThreads(){
      threadsBox.innerHTML = `<div class="no-threads">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∏–∞–ª–æ–≥–æ–≤...</div>`;
      try{
        // API: —Å–ø–∏—Å–æ–∫ –¥–∏–∞–ª–æ–≥–æ–≤
        const url = `${API}/threads?status=${encodeURIComponent(statusFilter.value)}&search=${encodeURIComponent(searchBox.value)}&limit=50`;
        const res = await fetch(url, { credentials: "include" });
        const data = await res.json();
        if(!data.ok || !data.threads || !data.threads.length){
          threadsBox.innerHTML = `<div class="no-threads">–î–∏–∞–ª–æ–≥–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>`;
          return;
        }
        threadsBox.innerHTML = "";
        data.threads.forEach(t => {
          const wrap = document.createElement("div");
          wrap.className = "thread";
          if(selectedThread && selectedThread.id === t.id) wrap.classList.add("active");

          const ava = document.createElement("img");
          ava.className = "ava";
          ava.src = t.avatar_path ? fixUploadUrl(t.avatar_path) : "/assets/icons/user.svg";
          ava.alt = "avatar";

          const meta = document.createElement("div");
          meta.className = "meta";
          const name = document.createElement("h4");
          name.textContent = t.nick || `user#${t.user_id}`;
          const last = document.createElement("p");
          last.textContent = t.last_message || "–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π";
          meta.appendChild(name); meta.appendChild(last);

          const badges = document.createElement("div");
          badges.className = "badges";
          if(t.unread_count > 0){
            const b = document.createElement("span"); b.className = "badge gold";
            b.textContent = t.unread_count;
            badges.appendChild(b);
          }
          if(t.pinned){
            const b = document.createElement("span"); b.className = "badge pin";
            b.textContent = "PIN";
            badges.appendChild(b);
          }
          if(t.status === "resolved"){
            const b = document.createElement("span"); b.className = "badge";
            b.textContent = "–†–ï–®–ï–ù–û";
            badges.appendChild(b);
          }

          wrap.appendChild(ava);
          wrap.appendChild(meta);
          wrap.appendChild(badges);

          wrap.onclick = () => selectThread(t);
          threadsBox.appendChild(wrap);
        });
      }catch(e){
        threadsBox.innerHTML = `<div class="no-threads" style="color:#f77">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${e.message}</div>`;
      }
    }

    function fixUploadUrl(path){
      // –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –∫–∞–∫ "/uploads/..." —Ç–∞–∫ –∏ "avatars/....jpg"
      if(!path) return "";
      if(path.startsWith("/uploads/")) return path;
      return "/uploads/" + path.replace(/^\/+/,'');
    }

    async function selectThread(t){
      selectedThread = t;
      // —Ö–µ–¥–µ—Ä
      chatNick.textContent = t.nick || `user#${t.user_id}`;
      chatMeta.textContent = `${t.email || "‚Äî"} ‚Ä¢ ${t.city || "‚Äî"} ‚Ä¢ ${t.gender || "‚Äî"}`;
      chatAva.src = t.avatar_path ? fixUploadUrl(t.avatar_path) : "/assets/icons/user.svg";

      // –∏–Ω—Ñ–æ–ø–∞–Ω–µ–ª—å
      u_id.textContent = t.user_id || "‚Äî";
      u_nick.textContent = t.nick || "‚Äî";
      u_email.textContent = t.email || "‚Äî";
      u_status.textContent = t.user_status || "‚Äî";
      u_balance.textContent = (typeof t.balance === "number" ? t.balance : "‚Äî");
      u_city.textContent = t.city || "‚Äî";
      u_premium.textContent = t.premium ? "–î–∞" : "–ù–µ—Ç";

      // –∫–Ω–æ–ø–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è
      pinBtn.dataset.pinned = t.pinned ? "1" : "0";
      pinBtn.textContent = t.pinned ? "üìå –û—Ç–∫—Ä–µ–ø–∏—Ç—å" : "üìå –ó–∞–∫—Ä–µ–ø–∏—Ç—å";
      resolveBtn.dataset.resolved = (t.status === "resolved") ? "1" : "0";
      resolveBtn.textContent = (t.status === "resolved") ? "‚Ü©Ô∏è –°–Ω–æ–≤–∞ –æ—Ç–∫—Ä—ã—Ç—å" : "‚úÖ –†–µ—à–µ–Ω–æ";

      await loadMessages();
      startPolling();
      // –ø–æ–º–µ—á–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –≤ —Å–ø–∏—Å–∫–µ
      [...document.querySelectorAll(".thread")].forEach(el=>el.classList.remove("active"));
      const idx = [...threadsBox.children].findIndex(el=> (el.querySelector('h4')?.textContent||"") === (t.nick||`user#${t.user_id}`));
      if(threadsBox.children[idx]) threadsBox.children[idx].classList.add("active");
    }

    async function loadMessages(){
      messagesBox.innerHTML = `<div class="no-threads" style="padding:16px;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>`;
      if(!selectedThread) return;
      try{
        // API: —Å–æ–æ–±—â–µ–Ω–∏—è —Ç—Ä–µ–¥–∞
        const res = await fetch(`${API}/thread/${selectedThread.id}/messages`, { credentials:"include" });
        const data = await res.json();
        if(!data.ok || !data.messages) {
          messagesBox.innerHTML = `<div class="no-threads" style="padding:16px;">–°–æ–æ–±—â–µ–Ω–∏–π –Ω–µ—Ç</div>`;
          return;
        }
        messagesBox.innerHTML = "";
        data.messages.forEach(m => {
          const row = document.createElement("div");
          row.className = "msg" + (m.sender === "admin" ? " me" : "");
          const bubble = document.createElement("div");
          bubble.className = "bubble";

          if(m.text){
            const p = document.createElement("div");
            p.textContent = m.text;
            bubble.appendChild(p);
          }
          if(m.image_url){
            const img = document.createElement("img");
            img.src = fixUploadUrl(m.image_url);
            img.alt = "image";
            img.onclick = ()=>openImage(img.src);
            bubble.appendChild(img);
          }
          if(m.file_url && !m.image_url){
            const file = document.createElement("div");
            file.className = "file";
            file.innerHTML = `üìé <a href="${fixUploadUrl(m.file_url)}" target="_blank">${m.file_name || '–§–∞–π–ª'}</a>`;
            bubble.appendChild(file);
          }
          const tm = document.createElement("time");
          tm.textContent = new Date(m.created_at).toLocaleString('ru-RU');
          row.appendChild(bubble);
          row.appendChild(tm);
          messagesBox.appendChild(row);
        });
        messagesBox.scrollTop = messagesBox.scrollHeight;
      }catch(e){
        messagesBox.innerHTML = `<div class="no-threads" style="color:#f77;padding:16px;">–û—à–∏–±–∫–∞: ${e.message}</div>`;
      }
    }

    function startPolling(){
      if(pollTimer) clearInterval(pollTimer);
      pollTimer = setInterval(loadMessages, 5000);
    }

    function stopPolling(){
      if(pollTimer){ clearInterval(pollTimer); pollTimer = null; }
    }

    function openImage(src){
      imgModalPic.src = src;
      imgModal.style.display = "flex";
    }

    // –ë—ã—Å—Ç—Ä—ã–µ –æ—Ç–≤–µ—Ç—ã
    document.getElementById("quickReplies").addEventListener("click", (e)=>{
      if(e.target.tagName === "BUTTON"){
        msgInput.value = e.target.textContent;
        msgInput.focus();
      }
    });

    // –û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ–∫—Å—Ç–∞
    sendBtn.onclick = async ()=>{
      if(!selectedThread) return;
      const text = msgInput.value.trim();
      const hasFile = filePicker.files.length > 0;

      if(!text && !hasFile) return;

      try{
        if(hasFile){
          const form = new FormData();
          if(text) form.append("text", text);
          form.append("file", filePicker.files[0]);
          // API: –æ—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–∞–π–ª–∞/–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
          const res = await fetch(`${API}/thread/${selectedThread.id}/upload`, {
            method:"POST", credentials:"include", body:form
          });
          const data = await res.json();
          if(!data.ok) throw new Error(data.error||"upload_failed");
          filePicker.value = "";
        }
        if(text && !hasFile){
          // API: –æ—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
          const res = await fetch(`${API}/thread/${selectedThread.id}/message`, {
            method:"POST", headers:{"Content-Type":"application/json"},
            credentials:"include",
            body: JSON.stringify({ text })
          });
          const data = await res.json();
          if(!data.ok) throw new Error(data.error||"send_failed");
        }
        msgInput.value = "";
        await loadMessages();
      }catch(e){
        alert("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: "+e.message);
      }
    };

    // –ü–∏–Ω / –†–µ—à–µ–Ω–æ
    pinBtn.onclick = async ()=>{
      if(!selectedThread) return;
      const next = pinBtn.dataset.pinned === "1" ? 0 : 1;
      // API: –∏–∑–º–µ–Ω–∏—Ç—å —Å–≤–æ–π—Å—Ç–≤–∞ —Ç—Ä–µ–¥–∞
      const res = await fetch(`${API}/thread/${selectedThread.id}`, {
        method:"PATCH", headers:{"Content-Type":"application/json"},
        credentials:"include",
        body: JSON.stringify({ pinned: !!next })
      });
      const data = await res.json();
      if(data.ok){
        pinBtn.dataset.pinned = String(next);
        pinBtn.textContent = next ? "üìå –û—Ç–∫—Ä–µ–ø–∏—Ç—å" : "üìå –ó–∞–∫—Ä–µ–ø–∏—Ç—å";
        loadThreads();
      }
    };
    resolveBtn.onclick = async ()=>{
      if(!selectedThread) return;
      const next = resolveBtn.dataset.resolved === "1" ? "active" : "resolved";
      const res = await fetch(`${API}/thread/${selectedThread.id}`, {
        method:"PATCH", headers:{"Content-Type":"application/json"},
        credentials:"include",
        body: JSON.stringify({ status: next })
      });
      const data = await res.json();
      if(data.ok){
        resolveBtn.dataset.resolved = next === "resolved" ? "1" : "0";
        resolveBtn.textContent = next === "resolved" ? "‚Ü©Ô∏è –°–Ω–æ–≤–∞ –æ—Ç–∫—Ä—ã—Ç—å" : "‚úÖ –†–µ—à–µ–Ω–æ";
        loadThreads();
      }
    };

    // –û—Ç–∫—Ä—ã—Ç—å –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–Ω–æ–≤–∞—è –≤–∫–ª–∞–¥–∫–∞ –∞–¥–º–∏–Ω-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å –ø–æ–∏—Å–∫–æ–º)
    openUserBtn.onclick = ()=>{
      if(!selectedThread) return;
      const q = encodeURIComponent(selectedThread.nick || selectedThread.email || selectedThread.user_id);
      window.open(`/admin/admin-users.html?search=${q}`, "_blank");
    };

    // –§–∏–ª—å—Ç—Ä—ã/–ø–æ–∏—Å–∫
    document.getElementById("searchBtn").onclick = ()=>loadThreads();
    statusFilter.onchange = ()=>loadThreads();

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    loadThreads();
  </script>
</body>
</html>
