<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ ‚Äî TwinSide Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="../assets/admin.css">
  <style>
    .users-toolbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 20px 0;
      flex-wrap: wrap;
      gap: 10px;
    }
    .users-toolbar select, .users-toolbar input {
      background: #141418;
      border: none;
      color: #fff;
      padding: 10px;
      border-radius: 8px;
      font-size: 14px;
    }
    .users-toolbar button {
      background: #F2C94C;
      color: #0B0B0D;
      border: none;
      border-radius: 8px;
      padding: 10px 16px;
      font-weight: 600;
      cursor: pointer;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: #0B0B0D;
      border-radius: 12px;
      overflow: hidden;
    }
    th, td {
      padding: 10px 14px;
      border-bottom: 1px solid rgba(255,255,255,.1);
      font-size: 14px;
    }
    th {
      text-transform: uppercase;
      color: #F2C94C;
      font-size: 13px;
    }
    td { color: #EAEAEA; }
    .action-btn {
      background: #7F3DF4;
      border: none;
      padding: 6px 10px;
      margin: 2px;
      border-radius: 6px;
      color: #fff;
      cursor: pointer;
      font-size: 12px;
    }
    .pagination {
      margin-top: 20px;
      text-align: center;
    }
    .pagination button {
      background: #141418;
      color: #fff;
      border: none;
      border-radius: 6px;
      margin: 0 5px;
      padding: 6px 12px;
      cursor: pointer;
    }
    .pagination button.active {
      background: #7F3DF4;
    }
    /* –ú–æ–¥–∞–ª–∫–∞ */
    .modal {
      display: none;
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,.7);
      justify-content: center;
      align-items: center;
      z-index: 999;
    }
    .modal-content {
      background: #141418;
      padding: 20px;
      border-radius: 12px;
      width: 90%;
      max-width: 500px;
      color: #fff;
    }
    .modal-content input, .modal-content textarea, .modal-content select {
      width: 100%;
      margin: 6px 0;
      padding: 10px;
      border: none;
      border-radius: 6px;
      background: #0B0B0D;
      color: #fff;
    }
    .modal-content button {
      background: #F2C94C;
      color: #0B0B0D;
      font-weight: 600;
      border: none;
      padding: 10px 16px;
      border-radius: 8px;
      cursor: pointer;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <header>
    <h1>üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h1>
    <nav class="admin-nav">
      <a href="/admin/admin.html">üè† –î–∞—à–±–æ—Ä–¥</a>
      <a href="/admin/admin-pending.html">–ê–Ω–∫–µ—Ç—ã</a>
      <a class="active" href="/admin/admin-users.html">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</a>
      <a href="/admin/admin-finance.html">–§–∏–Ω–∞–Ω—Å—ã</a>
      <a href="/admin/admin-promos.html">–ü—Ä–æ–º–æ–∫–æ–¥—ã</a>
      <a href="/admin/admin-support.html">–ü–æ–¥–¥–µ—Ä–∂–∫–∞</a>
      <a href="/admin/admin-ads.html">–†–µ–∫–ª–∞–º–∞</a>
    </nav>
    <button id="logout" class="btn">–í—ã–π—Ç–∏</button>
  </header>

  <main>
    <div class="dashboard">
      <div class="users-toolbar">
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <input id="search" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∏–∫—É –∏–ª–∏ email...">
          <select id="type-filter">
            <option value="all">–í—Å–µ</option>
            <option value="real">–†–µ–∞–ª—å–Ω—ã–µ</option>
            <option value="fake">–§–µ–π–∫–æ–≤—ã–µ</option>
          </select>
          <button id="search-btn">üîç –ü–æ–∏—Å–∫</button>
        </div>
        <button id="create-fake" class="btn gold">‚ûï –°–æ–∑–¥–∞—Ç—å —Ñ–µ–π–∫</button>
      </div>

      <table id="users-table">
        <thead>
          <tr>
            <th>ID</th><th>–ù–∏–∫</th><th>Email</th><th>–ü–æ–ª</th><th>–¢–∏–ø</th>
            <th>–ì–æ—Ä–æ–¥</th><th>–ë–∞–ª–∞–Ω—Å</th><th>–°—Ç–∞—Ç—É—Å</th><th>–î–µ–π—Å—Ç–≤–∏—è</th>
          </tr>
        </thead>
        <tbody id="users-body">
          <tr><td colspan="9" style="text-align:center;color:#999;">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>
        </tbody>
      </table>

      <div class="pagination" id="pagination"></div>
    </div>
  </main>

  <footer>¬© TwinSide Admin 2025</footer>

  <!-- –ú–æ–¥–∞–ª–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ñ–µ–π–∫–∞ -->
  <div class="modal" id="fake-modal">
    <div class="modal-content">
      <h3>–°–æ–∑–¥–∞–Ω–∏–µ —Ñ–µ–π–∫-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h3>
      <input id="fake-nick" placeholder="–ù–∏–∫">
      <select id="fake-gender">
        <option value="woman">–ñ–µ–Ω—â–∏–Ω–∞</option>
        <option value="man">–ú—É–∂—á–∏–Ω–∞</option>
        <option value="pair">–ü–∞—Ä–∞</option>
        <option value="trans">–¢—Ä–∞–Ω—Å</option>
      </select>
      <input id="fake-city" placeholder="–ì–æ—Ä–æ–¥">
      <textarea id="fake-about" rows="3" placeholder="–û —Å–µ–±–µ"></textarea>
      <textarea id="fake-interests" rows="2" placeholder="–ò–Ω—Ç–µ—Ä–µ—Å—ã —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é"></textarea>
      <button id="save-fake">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
  </div>

  <script>
    const API = "http://localhost:3000/api/admin";
    let currentPage = 1;

    async function loadUsers() {
      const search = document.getElementById("search").value;
      const type = document.getElementById("type-filter").value;
      const res = await fetch(`${API}/users?search=${encodeURIComponent(search)}&type=${type}&page=${currentPage}`, { credentials: "include" });
      const data = await res.json();

      const tbody = document.getElementById("users-body");
      if (!data.ok || !data.users.length) {
        tbody.innerHTML = "<tr><td colspan='9' style='text-align:center;color:#999;'>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</td></tr>";
        return;
      }
      tbody.innerHTML = "";
      data.users.forEach(u => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${u.id}</td>
          <td>${u.nick}</td>
          <td>${u.email || "‚Äî"}</td>
          <td>${u.gender || "‚Äî"}</td>
          <td>${u.is_fake ? "ü™Ñ –§–µ–π–∫" : "üßç –†–µ–∞–ª—å–Ω—ã–π"}</td>
          <td>${u.city || "‚Äî"}</td>
          <td>${u.balance}</td>
          <td>${u.status}</td>
          <td>
            <button class="action-btn" onclick="toggleBan(${u.id}, ${u.banned ? 0 : 1})">${u.banned ? "–†–∞–∑–±–∞–Ω–∏—Ç—å" : "–ó–∞–±–∞–Ω–∏—Ç—å"}</button>
            <button class="action-btn" onclick="editBalance(${u.id}, ${u.balance})">üí∞ –ë–∞–ª–∞–Ω—Å</button>
            <button class="action-btn" onclick="togglePremium(${u.id}, ${u.premium ? 0 : 1})">${u.premium ? "–°–Ω—è—Ç—å‚≠ê" : "–î–∞—Ç—å‚≠ê"}</button>
            ${u.is_fake ? `<button class="action-btn" onclick="deleteFake(${u.id})">üóë –£–¥–∞–ª–∏—Ç—å</button>` : ""}
          </td>
        `;
        tbody.appendChild(row);
      });

      renderPagination(data.pagination);
    }

    function renderPagination(p) {
      const div = document.getElementById("pagination");
      div.innerHTML = "";
      for (let i = 1; i <= p.totalPages; i++) {
        const btn = document.createElement("button");
        btn.textContent = i;
        btn.classList.toggle("active", i === p.page);
        btn.onclick = () => { currentPage = i; loadUsers(); };
        div.appendChild(btn);
      }
    }

    async function toggleBan(id, banned) {
      await fetch(`${API}/user/${id}`, {
        method: "PATCH",
        headers: { "Content-Type": "application/json" },
        credentials: "include",
        body: JSON.stringify({ banned })
      });
      loadUsers();
    }

    async function togglePremium(id, premium) {
      await fetch(`${API}/user/${id}`, {
        method: "PATCH",
        headers: { "Content-Type": "application/json" },
        credentials: "include",
        body: JSON.stringify({ premium })
      });
      loadUsers();
    }

    async function editBalance(id, oldBalance) {
      const newBalance = prompt("–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π –±–∞–ª–∞–Ω—Å:", oldBalance);
      if (newBalance === null) return;
      await fetch(`${API}/user/${id}`, {
        method: "PATCH",
        headers: { "Content-Type": "application/json" },
        credentials: "include",
        body: JSON.stringify({ balance: parseInt(newBalance) })
      });
      loadUsers();
    }

    // === –°–æ–∑–¥–∞–Ω–∏–µ —Ñ–µ–π–∫–∞ ===
    document.getElementById("create-fake").onclick = async () => {
  const nick = prompt("–í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫ —Ñ–µ–π–∫–∞:");
  if (!nick) return;
  const city = prompt("–ì–æ—Ä–æ–¥ (–º–æ–∂–Ω–æ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å):", "–ö–∏–µ–≤");
  const gender = prompt("–ü–æ–ª (man / woman / pair / trans):", "woman");
  const about = prompt("–û–ø–∏—Å–∞–Ω–∏–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):", "–§–µ–π–∫–æ–≤—ã–π –ø—Ä–æ—Ñ–∏–ª—å –¥–ª—è —Ç–µ—Å—Ç–∞.");

  const res = await fetch(`${API}/fake`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    credentials: "include",
    body: JSON.stringify({ nick, city, gender, about })
  });

  const data = await res.json();
  if (data.ok) {
    alert("‚úÖ –§–µ–π–∫–æ–≤—ã–π –ø—Ä–æ—Ñ–∏–ª—å —Å–æ–∑–¥–∞–Ω");
    loadUsers();
  } else {
    alert("–û—à–∏–±–∫–∞: " + (data.error || "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å"));
  }
};

    async function deleteFake(id) {
      if (!confirm("–£–¥–∞–ª–∏—Ç—å —Ñ–µ–π–∫-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?")) return;
      await fetch(`${API}/user/${id}`, { method: "DELETE", credentials: "include" });
      loadUsers();
    }

    document.getElementById("search-btn").onclick = () => { currentPage = 1; loadUsers(); };
    document.getElementById("logout").onclick = async () => {
      await fetch(`${API}/logout`, { method: "POST", credentials: "include" });
      location.href = "/admin/admin.html";
    };

    loadUsers();
  </script>
</body>
</html>
