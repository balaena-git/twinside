<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–î—Ä—É–∑—å—è ‚Äî TwinSide</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
</head>
<body>
  <div id="app-content">
    <section class="widget">
      <h3>–ú–æ–∏ –¥—Ä—É–∑—å—è</h3>
      <div id="friends" class="grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px"></div>
    </section>
    <section class="widget">
      <h3>–ó–∞—è–≤–∫–∏ –≤ –¥—Ä—É–∑—å—è</h3>
      <div id="requests" class="grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px"></div>
    </section>
  </div>

  <script src="/app/js/app-shell.js" defer></script>
  <script>
    function card(u, actions){
      const el = document.createElement('div');
      el.className='card';
      el.style = 'background:#141418;border-radius:12px;padding:12px;display:flex;flex-direction:column;align-items:center;gap:8px;box-shadow:0 0 15px rgba(127,61,244,.15)';
      el.innerHTML = `
        <img src="${u.avatar || '/assets/icons/user.svg'}" width="96" height="96" style="border-radius:50%;border:2px solid #7f3df4;object-fit:cover"/>
        <h4 style="margin:0">${u.nick || '‚Äî'} ${u.premium?'üëë':''}</h4>
        <div style="color:#CFCFE2">${u.city||'–ì–æ—Ä–æ–¥ –Ω–µ —É–∫–∞–∑–∞–Ω'} ¬∑ ${u.gender||'‚Äî'}</div>
      `;
      if (actions) el.appendChild(actions);
      return el;
    }

    async function load(){
      const fWrap = document.getElementById('friends');
      const rWrap = document.getElementById('requests');
      fWrap.innerHTML = '<div class="table-message">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>';
      rWrap.innerHTML = '<div class="table-message">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>';
      try{
        const fr = await (await fetch('/friends', { credentials:'include' })).json();
        const rq = await (await fetch('/friends/requests', { credentials:'include' })).json();
        fWrap.innerHTML = '';
        rWrap.innerHTML = '';
        (fr.friends||[]).forEach(u=>{
          const actions = document.createElement('div');
          actions.style='display:flex;gap:8px';
          const prof = document.createElement('a'); prof.className='btn'; prof.href='/app/profile?id='+u.id; prof.textContent='–ü—Ä–æ—Ñ–∏–ª—å'; actions.appendChild(prof);
          const rm = document.createElement('button'); rm.className='btn'; rm.textContent='–£–¥–∞–ª–∏—Ç—å'; rm.onclick = ()=>remove(u.id); actions.appendChild(rm);
          fWrap.appendChild(card(u, actions));
        });
        (rq.incoming||[]).forEach(u=>{
          const actions = document.createElement('div');
          actions.style='display:flex;gap:8px';
          const acc = document.createElement('button'); acc.className='btn'; acc.textContent='–ü—Ä–∏–Ω—è—Ç—å'; acc.onclick = ()=>accept(u.id); actions.appendChild(acc);
          const rej = document.createElement('button'); rej.className='btn'; rej.textContent='–û—Ç–∫–ª–æ–Ω–∏—Ç—å'; rej.onclick = ()=>remove(u.id); actions.appendChild(rej);
          rWrap.appendChild(card(u, actions));
        });
        if (!fr.friends || fr.friends.length===0) fWrap.innerHTML='<div class="table-message">–ü–æ–∫–∞ –Ω–µ—Ç –¥—Ä—É–∑–µ–π</div>';
        if (!rq.incoming || rq.incoming.length===0) rWrap.innerHTML='<div class="table-message">–ù–µ—Ç –≤—Ö–æ–¥—è—â–∏—Ö –∑–∞—è–≤–æ–∫</div>';
      }catch(e){
        fWrap.innerHTML = '<div class="table-message">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>';
        rWrap.innerHTML = '<div class="table-message">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>';
      }
    }

    async function accept(id){ await fetch('/friends/'+id, { method:'POST', credentials:'include' }); load(); }
    async function remove(id){ await fetch('/friends/'+id, { method:'DELETE', credentials:'include' }); load(); }

    document.addEventListener('DOMContentLoaded', load);
  </script>
</body>
</html>

