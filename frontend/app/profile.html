<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–ü—Ä–æ—Ñ–∏–ª—å ‚Äî TwinSide</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
</head>
<body>
  <div id="app-content">
    <!-- Top combined block: left photo+premium+gifts+album, right info -->
    <section class="profile-top">
      <div class="profile-photo-card">
        <div class="profile-photo-wrap">
          <img id="p-ava" class="profile-avatar" src="/assets/icons/user.svg" alt="avatar"/>
          <div class="premium-badge-slot"><span id="premium-label" class="premium-badge">‚Äî</span></div>
        </div>
        <div class="profile-side-card">
          <div class="profile-side-title">–ü–æ–¥–∞—Ä–∫–∏</div>
          <div class="profile-side-body gift-row" id="gifts-row"></div>
        </div>
        <div class="profile-side-card">
          <div class="profile-side-title">–ê–ª—å–±–æ–º</div>
          <div class="profile-side-body">
            <div class="thumbs mini" id="photos-preview"></div>
            <a id="photos-link" href="/app/photos" class="link profile-side-link">–í—Å–µ —Ñ–æ—Ç–æ</a>
          </div>
        </div>
      </div>
      <div class="profile-info-card">
        <h1 id="p-nick" class="profile-name">‚Äî</h1>
        <div id="p-meta" class="profile-meta">‚Äî</div>
        <div id="online" class="profile-meta">‚Äî</div>
        <div class="badges" id="p-badges"></div>
        <div class="counters">
          <div class="counter"><b id="c-friends">0</b><span>–î—Ä—É–∑—å—è</span></div>
          <div class="counter"><b id="c-photos">0</b><span>–§–æ—Ç–æ</span></div>
          <div class="counter"><b id="c-posts">0</b><span>–ü–æ—Å—Ç—ã</span></div>
        </div>

        <section class="profile-section" style="margin-top:12px">
          <h3>–û —Å–µ–±–µ</h3>
          <p id="p-about">‚Äî</p>
          <div id="edit-row" style="margin-top:8px; display:none">
            <textarea id="about-edit" placeholder="–û —Å–µ–±–µ" maxlength="300" style="width:100%; min-height:80px; background:#0b0b0d; color:#fff; border:1px solid #1c1c22; border-radius:8px; padding:8px;"></textarea>
            <div class="row">
              <input id="interests-edit" placeholder="–ò–Ω—Ç–µ—Ä–µ—Å—ã —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é" style="flex:1; background:#0b0b0d; color:#fff; border:1px solid #1c1c22; border-radius:8px; padding:8px" />
              <button id="save-info" class="btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
              <button id="cancel-info" class="btn ghost">–û—Ç–º–µ–Ω–∞</button>
            </div>
          </div>
        </section>

        <section class="profile-section">
          <h3>–ò–Ω—Ç–µ—Ä–µ—Å—ã</h3>
          <div id="p-interests" class="chips"></div>
          <div style="margin-top:8px" id="who-looking"></div>
        </section>

        <div id="p-actions" style="margin-top:10px;display:flex;gap:8px"></div>
      </div>
    </section>

    <!-- Bottom: friends + composer -->
    <section class="profile-bottom" id="profile-bottom">
      <div class="profile-bottom-left">
        <div class="profile-friends-card">
          <div class="header">
            <h3>–î—Ä—É–∑—å—è</h3>
            <a href="/app/friends">–í—Å–µ</a>
          </div>
          <div class="friends-row" id="friends-preview"></div>
        </div>
      </div>
      <div class="profile-bottom-right">
        <div class="profile-composer-card" id="composer-card" style="display:none">
          <div class="composer-input">
            <textarea id="post-text" placeholder="–ß—Ç–æ —É –≤–∞—Å –Ω–æ–≤–æ–≥–æ?" maxlength="700"></textarea>
            <button class="composer-send" id="composer-submit" type="button" title="–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å"></button>
          </div>
          <div class="composer-tools">
            <button class="composer-tool active" data-mode="post" type="button" title="–¢–µ–∫—Å—Ç"><span>üìù</span></button>
            <button class="composer-tool" data-mode="photo" type="button" title="–§–æ—Ç–æ"><span>üì∑</span></button>
            <button class="composer-tool" data-mode="poll" type="button" title="–û–ø—Ä–æ—Å"><span>üìä</span></button>
          </div>
          <div class="composer-extra">
            <div class="composer-upload" id="composer-upload">
              <input id="post-photo" type="file" accept="image/*" multiple />
              <span class="composer-description">–ú–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –¥–æ 10 —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π</span>
            </div>
            <div class="composer-poll" id="composer-poll" style="display:none">
              <input type="text" id="poll-question" placeholder="–í–æ–ø—Ä–æ—Å" />
              <textarea id="poll-options" placeholder="–í–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–∞, –∫–∞–∂–¥—ã–π —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏"></textarea>
              <label class="composer-poll-note">
                <input type="checkbox" id="poll-anon" /> –ê–Ω–æ–Ω–∏–º–Ω–æ–µ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ
              </label>
            </div>
          </div>
        </div>
      </div>
    </section>
    <section class="profile-feed" id="profile-feed">
      <div class="profile-feed-card">
        <div class="profile-feed-header">
          <h3>–õ–µ–Ω—Ç–∞</h3>
        </div>
        <div class="profile-feed-list" id="profile-feed-grid"></div>
      </div>
    </section>
    
  </div>

  <script src="/app/js/app-shell.js" defer></script>
  <link rel="stylesheet" href="/assets/app.css?v=profile4" />
  <script>
    let currentProfile = null;
    let currentProfileIsMe = false;
    let profilePhotos = [];
    let profilePosts = [];
    let profilePostsLoading = false;
    const postCommentsCache = new Map();
    const hydratedCommentThreads = new Set();
    const postCommentsLoading = new Set();

    async function loadProfile(){
      const params = new URLSearchParams(window.location.search);
      const userId = params.get('id');
      try {
        if (userId) {
          const r = await fetch(`/users/${userId}/profile`);
          const data = await r.json();
          if (!data.ok) throw new Error(data.error||'not_found');
          render(data.profile, false);
          loadFriendsPreview(parseInt(userId,10), false);
          loadPhotosPreview(parseInt(userId,10));
        } else {
          const r = await fetch('/me/overview', { credentials:'include' });
          const me = await r.json();
          if (!me.ok) { window.location.href='/public/auth'; return; }
          render(me.profile, true);
          loadFriendsPreview(me.profile.id, true);
          loadPhotosPreview(me.profile.id);
        }
      } catch(e){
        document.getElementById('app-content').innerHTML = `<div class=\"table-message\">–û—à–∏–±–∫–∞: ${e.message}</div>`;
      }
    }

    function render(p, isMe){
      currentProfile = p;
      currentProfileIsMe = isMe;
      profilePhotos = [];
      profilePosts = [];
      profilePostsLoading = true;
      if (p.avatar) document.getElementById('p-ava').src = p.avatar;
      const name = `${p.nick||'‚Äî'} ${p.premium?'üëë':''}`;
      document.getElementById('p-nick').textContent = name;
      const agePart = p.age ? ` ¬∑ ${p.age}` : '';
      document.getElementById('p-meta').textContent = `${p.city||'–ì–æ—Ä–æ–¥ –Ω–µ —É–∫–∞–∑–∞–Ω'} ¬∑ ${p.gender||'‚Äî'}${agePart}`;
      // online/offline
      const onlineEl = document.getElementById('online');
      const last = p.last_active ? new Date(p.last_active) : null;
      const online = last ? (Date.now() - last.getTime() < 5*60*1000) : false;
      onlineEl.textContent = online ? '–û–Ω–ª–∞–π–Ω' : (last ? `–ë—ã–ª(–∞) –≤ —Å–µ—Ç–∏: ${last.toLocaleString('ru-RU')}` : '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏');
      document.getElementById('p-about').textContent = p.about || '‚Äî';
      const interestsWrap = document.getElementById('p-interests');
      interestsWrap.innerHTML = '';
      const interests = (p.interests||'').split(',').map(s=>s.trim()).filter(Boolean);
      if (interests.length===0) interestsWrap.innerHTML = '<span class="chip">‚Äî</span>';
      interests.forEach(tag=>{ const t=document.createElement('span'); t.className='chip'; t.textContent=tag; interestsWrap.appendChild(t); });

      if (p.counters){
        document.getElementById('c-friends').textContent = p.counters.friends||0;
        document.getElementById('c-photos').textContent = p.counters.photos||0;
        document.getElementById('c-posts').textContent = p.counters.posts||0;
      }

      const whoWrap = document.getElementById('who-looking');
      const who = p.gender==='man'?'–û–Ω': p.gender==='woman'?'–û–Ω–∞': p.gender==='pair'?'–ü–∞—Ä–∞': '‚Äî';
      const looking = (p.looking_for||'').split(',').map(s=>s.trim()).filter(Boolean).join(', ');
      whoWrap.textContent = `${who} ¬∑ –ò—â–µ—Ç: ${looking||'‚Äî'}`;

      const actions = document.getElementById('p-actions');
      actions.innerHTML = '';
      const composerCard = document.getElementById('composer-card');
      if (composerCard) composerCard.style.display = isMe ? 'block' : 'none';
      const composerWrap = document.querySelector('.profile-bottom-right');
      if (composerWrap) composerWrap.style.display = isMe ? 'flex' : 'none';
      const bottomSection = document.getElementById('profile-bottom');
      if (bottomSection) bottomSection.classList.toggle('single', !isMe);
      if (isMe) {
        const a2 = document.createElement('button'); a2.className='btn'; a2.textContent='–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å'; a2.onclick=enableEdit; actions.appendChild(a2);
        const a1 = document.createElement('a'); a1.className='btn ghost'; a1.href='/app/wallet'; a1.textContent='–ö–æ—à–µ–ª—ë–∫'; actions.appendChild(a1);
      } else {
        const m = document.createElement('button'); m.className='btn'; m.textContent='–ù–∞–ø–∏—Å–∞—Ç—å'; actions.appendChild(m);
        const f = document.createElement('button'); f.className='btn'; f.textContent='–í –¥—Ä—É–∑—å—è'; f.addEventListener('click', ()=>friend(p.id)); actions.appendChild(f);
        const r = document.createElement('button'); r.className='btn ghost'; r.textContent='–ü–æ–∂–∞–ª–æ–≤–∞—Ç—å—Å—è'; actions.appendChild(r);
      }

      // premium label
      const prem = document.getElementById('premium-label');
      const prefLabel = p.premium ? '–ü—Ä–µ–º–∏—É–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å' : '–û–±—ã—á–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
      prem.textContent = prefLabel;
      prem.className = `premium-badge ${p.premium ? 'premium' : 'basic'}`;

      const giftsRow = document.getElementById('gifts-row');
      if (giftsRow) {
        giftsRow.innerHTML = '';
        const empty = document.createElement('span');
        empty.className = 'gift empty';
        empty.textContent = '–ü–æ–¥–∞—Ä–∫–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç';
        giftsRow.appendChild(empty);
      }

      const photosLink = document.getElementById('photos-link');
      if (photosLink) photosLink.textContent = `–í—Å–µ —Ñ–æ—Ç–æ (${p.counters?.photos ?? 0})`;

      renderProfileFeed();
      loadPosts(p.id, isMe);
    }

    function renderProfileFeed(){
      const wrap = document.getElementById('profile-feed-grid');
      if (!wrap || !currentProfile) return;

      if (profilePostsLoading) {
        wrap.innerHTML = '<div class="profile-feed-status">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>';
        return;
      }

      const modeLabel = {
        post: '–ü–æ—Å—Ç',
        photo: '–§–æ—Ç–æ',
        poll: '–û–ø—Ä–æ—Å',
      };

      const items = [...profilePosts]
        .map(item => ({
          id: item.id,
          user_id: item.user_id,
          kind: item.kind || 'post',
          text: item.text || '',
        attachments: Array.isArray(item.attachments) ? item.attachments : [],
        poll: item.poll || null,
        created_at: item.created_at || null,
        likes: typeof item.likes === 'number' ? item.likes : 0,
        liked: !!item.liked,
        comments: typeof item.comments === 'number' ? item.comments : 0,
      }))
        .sort((a, b) => {
          const da = a.created_at ? new Date(a.created_at).getTime() : 0;
          const db = b.created_at ? new Date(b.created_at).getTime() : 0;
          return db - da;
        });

      wrap.innerHTML = '';
      if (!items.length) {
        wrap.innerHTML = `<div class="profile-feed-status">${currentProfileIsMe ? '–ó–¥–µ—Å—å –ø–æ—è–≤—è—Ç—Å—è –≤–∞—à–∏ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏.' : '–£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ–∫–∞ –Ω–µ—Ç –ø—É–±–ª–∏–∫–∞—Ü–∏–π.'}</div>`;
        return;
      }

      items.forEach(item => {
        const card = document.createElement('article');
        card.className = 'profile-feed-entry profile-feed-entry-post';
        const kind = item.kind || 'post';
        card.dataset.mode = kind;
        card.dataset.postId = item.id;

        const header = document.createElement('div');
        header.className = 'profile-feed-entry-header';
        const author = document.createElement('div');
        author.className = 'profile-feed-entry-author';
        author.textContent = currentProfile.nick || '‚Äî';
        header.appendChild(author);

        const metaWrap = document.createElement('div');
        metaWrap.className = 'profile-feed-entry-meta';
        const tag = document.createElement('span');
        tag.className = 'profile-feed-entry-tag';
        tag.textContent = modeLabel[kind] || '–ü–æ—Å—Ç';
        metaWrap.appendChild(tag);

        if (item.created_at) {
          const date = document.createElement('span');
          date.className = 'profile-feed-entry-date';
          date.textContent = new Date(item.created_at).toLocaleString('ru-RU');
          metaWrap.appendChild(date);
        }
        header.appendChild(metaWrap);
        card.appendChild(header);

        if (item.text) {
          const text = document.createElement('p');
          text.className = 'profile-feed-entry-text';
          text.textContent = item.text;
          card.appendChild(text);
        }

        if (kind === 'poll' && item.poll) {
          const poll = document.createElement('div');
          poll.className = 'profile-feed-entry-poll';
          const question = document.createElement('strong');
          question.textContent = item.poll.question || item.text || '–û–ø—Ä–æ—Å';
          poll.appendChild(question);
          const options = document.createElement('ul');
          options.className = 'profile-feed-entry-list';
          (item.poll.options || []).forEach(opt => {
            const li = document.createElement('li');
            li.textContent = opt;
            options.appendChild(li);
          });
          poll.appendChild(options);
          if (item.poll.anonymous) {
            const note = document.createElement('div');
            note.className = 'profile-feed-entry-note';
            note.textContent = '–ê–Ω–æ–Ω–∏–º–Ω–æ–µ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ';
            poll.appendChild(note);
          }
          card.appendChild(poll);
        }

        if (item.attachments && item.attachments.length) {
          const gallery = document.createElement('div');
          gallery.className = 'profile-feed-entry-gallery';
          item.attachments.forEach(src => {
            const img = document.createElement('img');
            const link = typeof src === 'string' ? src : (src.url || src.path || src.src);
            img.src = link || '/assets/icons/user.svg';
            img.alt = 'attachment';
            img.onerror = () => { img.onerror = null; img.src = '/assets/icons/user.svg'; };
            if (link) {
              img.addEventListener('click', () => openLightbox(link));
            }
            gallery.appendChild(img);
          });
          card.appendChild(gallery);
        }

        const footer = document.createElement('div');
        footer.className = 'profile-feed-footer';
        const likeBtn = document.createElement('button');
        likeBtn.className = `profile-feed-action like ${item.liked ? 'active' : ''}`;
        likeBtn.dataset.action = 'like';
        likeBtn.dataset.postId = item.id;
        likeBtn.innerHTML = `<span class="icon">‚ù§</span><span class="count">${item.likes || 0}</span>`;
        footer.appendChild(likeBtn);

        const commentsBtn = document.createElement('button');
        commentsBtn.className = 'profile-feed-action comment';
        commentsBtn.dataset.action = 'comments';
        commentsBtn.dataset.postId = item.id;
        commentsBtn.innerHTML = `<span class="icon">üí¨</span><span class="count">${item.comments || 0}</span>`;
        footer.appendChild(commentsBtn);
        card.appendChild(footer);

        const commentsSection = document.createElement('div');
        commentsSection.className = 'profile-feed-comments';
        commentsSection.dataset.postId = item.id;
        commentsSection.hidden = true;
        commentsSection.style.display = 'none';

        const commentsList = document.createElement('div');
        commentsList.className = 'profile-feed-comments-list';
        commentsList.id = `comments-list-${item.id}`;
        commentsSection.appendChild(commentsList);

        const commentForm = document.createElement('form');
        commentForm.className = 'profile-feed-comment-form';
        commentForm.dataset.postId = item.id;
        commentForm.dataset.parentId = '';
        commentForm.innerHTML = `
          <input type="text" name="comment" placeholder="–ù–∞–ø–∏—Å–∞—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π" maxlength="500" required />
          <button type="submit" class="btn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        `;
        commentsSection.appendChild(commentForm);

        card.appendChild(commentsSection);

        wrap.appendChild(card);
      });
    }

    async function friend(id){
      try {
        const res = await fetch(`/friends/${id}`, { method:'POST', credentials:'include' });
        const data = await res.json();
        if (!data.ok) throw new Error(data.error||'server_error');
        alert(data.accepted ? '–ó–∞—è–≤–∫–∞ –ø—Ä–∏–Ω—è—Ç–∞' : '–ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞');
      } catch(e){ alert('–û—à–∏–±–∫–∞: '+e.message); }
    }

    async function loadFriendsPreview(userId, isMe){
      const wrap = document.getElementById('friends-preview');
      wrap.innerHTML = '';
      try{
        if (isMe){
          const fr = await (await fetch('/friends', { credentials:'include' })).json();
          (fr.friends||[]).slice(0,6).forEach(u=>{
            const a=document.createElement('a'); a.href='/app/profile?id='+u.id; a.title=u.nick||'';
            const img=document.createElement('img'); img.src=u.avatar||'/assets/icons/user.svg'; a.appendChild(img); wrap.appendChild(a);
          });
        } else {
          const pr = await (await fetch(`/users/${userId}/friends-preview`)).json();
          (pr.friends||[]).slice(0,6).forEach(u=>{ const a=document.createElement('a'); a.href='/app/profile?id='+u.id; const img=document.createElement('img'); img.src=u.avatar||'/assets/icons/user.svg'; a.appendChild(img); wrap.appendChild(a); });
        }
      }catch{}
      if (!wrap.children.length) wrap.innerHTML = '<div class="thumbs-empty">–ù–µ—Ç –¥—Ä—É–∑–µ–π</div>';
    }

    async function loadPhotosPreview(userId){
      const wrap = document.getElementById('photos-preview');
      wrap.innerHTML='';
      try{
        const res = await (await fetch(`/users/${userId}/photos?limit=6`)).json();
        if (res.ok){
          profilePhotos = res.photos || [];
          if (!res.photos.length) wrap.innerHTML='<div class="thumbs-empty">–ù–µ—Ç —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π</div>';
          res.photos.slice(0,6).forEach(p=>{ const img=document.createElement('img'); img.src=p.path; img.alt="photo"; img.addEventListener('click', ()=>openLightbox(p.path)); wrap.appendChild(img); });
        } else {
          profilePhotos = [];
          wrap.innerHTML='<div class="thumbs-empty">–ù–µ—Ç —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π</div>';
        }
      }catch{
        profilePhotos = [];
        wrap.innerHTML='<div class="thumbs-empty">–ù–µ—Ç —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π</div>';
      }
      const link = document.getElementById('photos-link');
      link.href = '/app/photos?id='+userId;
      renderProfileFeed();
    }

    async function loadPosts(userId, isMe){
      const wrap = document.getElementById('profile-feed-grid');
      profilePostsLoading = true;
      postCommentsCache.clear();
      hydratedCommentThreads.clear();
      if (wrap) wrap.innerHTML = '<div class="profile-feed-status">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>';
      try {
        const endpoint = isMe ? '/me/posts?limit=50' : `/users/${userId}/posts?limit=50`;
        const res = await fetch(endpoint, { credentials: 'include' });
        const data = await res.json();
        if (!data.ok) throw new Error(data.error || 'server_error');
        profilePosts = (data.posts || []).map(post => ({
          id: post.id,
          user_id: post.user_id,
          kind: post.kind || 'post',
          text: post.text || '',
          attachments: Array.isArray(post.attachments) ? post.attachments : [],
          poll: post.poll || null,
          created_at: post.created_at || null,
          likes: typeof post.likes === 'number' ? post.likes : 0,
          liked: !!post.liked,
          comments: typeof post.comments === 'number' ? post.comments : 0,
        }));
        const total = typeof data.total === 'number' ? data.total : profilePosts.length;
        if (currentProfile) {
          currentProfile.counters = currentProfile.counters || {};
          currentProfile.counters.posts = total;
          const postsCounter = document.getElementById('c-posts');
          if (postsCounter) postsCounter.textContent = currentProfile.counters.posts;
        }
      } catch (e) {
        profilePosts = [];
        if (wrap) wrap.innerHTML = `<div class="profile-feed-status">–û—à–∏–±–∫–∞: ${e.message}</div>`;
        profilePostsLoading = false;
        return;
      }
      profilePostsLoading = false;
      renderProfileFeed();
    }

    function prepareCommentNode(node){
      return {
        id: node.id,
        post_id: node.post_id,
        user_id: node.user_id,
        parent_id: node.parent_id ?? null,
        text: node.text || '',
        created_at: node.created_at || null,
        nick: node.nick || '',
        avatar: node.avatar || null,
        replies: Array.isArray(node.replies) ? node.replies.map(prepareCommentNode) : [],
      };
    }

    function normalizeCommentTree(list){
      return (list || []).map(prepareCommentNode);
    }

    function findCommentInTree(list, id){
      for (const item of list){
        if (item.id === id) return item;
        const child = findCommentInTree(item.replies || [], id);
        if (child) return child;
      }
      return null;
    }

    function updateCommentCount(postId, total, delta = 0){
      const post = findPost(postId);
      if (!post) return;
      const next = Number.isInteger(total) ? total : (post.comments ?? 0) + delta;
      post.comments = next;
      const countEl = document.querySelector(`.profile-feed-action.comment[data-post-id="${postId}"] .count`);
      if (countEl) countEl.textContent = next;
    }

    function createReplyForm(postId, parentId){
      const form = document.createElement('form');
      form.className = 'profile-feed-comment-form reply';
      form.dataset.postId = String(postId);
      form.dataset.parentId = String(parentId);
      form.hidden = true;
      form.innerHTML = `
        <input type="text" name="comment" placeholder="–û—Ç–≤–µ—Ç–∏—Ç—å" maxlength="500" required />
        <button type="submit" class="btn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      `;
      return form;
    }

    function enableEdit(){
      const box = document.getElementById('edit-row');
      box.style.display='block';
      document.getElementById('about-edit').value = document.getElementById('p-about').textContent;
      document.getElementById('interests-edit').value = (Array.from(document.querySelectorAll('#p-interests .chip')).map(el=>el.textContent).join(', '));
    }

    function findPost(id){
      return profilePosts.find(p => p.id === id);
    }

    function renderCommentNode(comm, postId){
      const wrapper = document.createElement('div');
      wrapper.className = 'profile-feed-comment-wrapper';
      wrapper.dataset.commentId = comm.id;
      wrapper.dataset.postId = String(postId);

      const row = document.createElement('div');
      row.className = 'profile-feed-comment';
      const avatar = document.createElement('img');
      avatar.className = 'profile-feed-comment-avatar';
      avatar.src = comm.avatar || '/assets/icons/user.svg';
      avatar.alt = comm.nick || '';
      avatar.onerror = () => { avatar.onerror = null; avatar.src = '/assets/icons/user.svg'; };

      const body = document.createElement('div');
      body.className = 'profile-feed-comment-body';

      const authorLine = document.createElement('div');
      authorLine.className = 'profile-feed-comment-header';
      const author = document.createElement('a');
      author.className = 'profile-feed-comment-author';
      author.textContent = comm.nick || '‚Äî';
      const text = document.createElement('div');
      text.className = 'profile-feed-comment-text';
      text.textContent = comm.text;
      const date = document.createElement('div');
      date.className = 'profile-feed-comment-date';
      date.textContent = comm.created_at ? new Date(comm.created_at).toLocaleString('ru-RU') : '';

      const replyBtn = document.createElement('button');
      replyBtn.className = 'profile-feed-comment-reply';
      replyBtn.dataset.commentId = comm.id;
      replyBtn.type = 'button';
      replyBtn.textContent = '–û—Ç–≤–µ—Ç–∏—Ç—å';

      const metaWrap = document.createElement('div');
      metaWrap.className = 'profile-feed-comment-meta';
      metaWrap.append(date, replyBtn);

      body.append(authorLine, text, metaWrap);
      row.append(avatar, body);
      wrapper.appendChild(row);

      const replySlot = document.createElement('div');
      replySlot.className = 'profile-feed-comment-reply-slot';
      replySlot.dataset.commentId = comm.id;
      replySlot.dataset.postId = String(postId);
      wrapper.appendChild(replySlot);

      const repliesCount = Array.isArray(comm.replies) ? comm.replies.length : 0;
      let thread = null;
      if (repliesCount){
        const toggleReplies = document.createElement('button');
        toggleReplies.className = 'profile-feed-comment-toggle';
        toggleReplies.type = 'button';
        toggleReplies.dataset.commentId = comm.id;
        toggleReplies.dataset.postId = String(postId);
        toggleReplies.dataset.state = 'hidden';
        toggleReplies.textContent = `–ü–æ–∫–∞–∑–∞—Ç—å –æ—Ç–≤–µ—Ç—ã (${repliesCount})`;
        toggleReplies.dataset.label = toggleReplies.textContent;
        wrapper.appendChild(toggleReplies);

        thread = document.createElement('div');
        thread.className = 'profile-feed-comment-thread';
        thread.dataset.commentId = comm.id;
        thread.hidden = true;
        thread.style.display = 'none';
        comm.replies.forEach(child => thread.appendChild(renderCommentNode(child, postId)));
        wrapper.appendChild(thread);
      }

      return wrapper;
    }

    function renderComments(postId){
      const list = document.getElementById(`comments-list-${postId}`);
      if (!list) return;
      const comments = postCommentsCache.get(postId) || [];
      list.innerHTML = '';
      if (!comments.length){
        list.innerHTML = '<div class="profile-feed-comment-empty">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</div>';
        return;
      }
      comments.forEach(comm => {
        const node = renderCommentNode(comm, postId);
        list.appendChild(node);
      });
      if (comments.length){
        const hideBtn = document.createElement('button'); hideBtn.className='profile-feed-comments-hide'; hideBtn.dataset.postId = String(postId); hideBtn.type='button'; hideBtn.textContent='–°–∫—Ä—ã—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏'; list.parentElement?.appendChild(hideBtn);
      }
    }

    async function ensureComments(postId){
      if (postCommentsCache.has(postId) && hydratedCommentThreads.has(postId)) {
        renderComments(postId);
        return;
      }
      if (postCommentsLoading.has(postId)) return;
      postCommentsLoading.add(postId);
      try {
        const res = await fetch(`/posts/${postId}/comments`, { credentials:'include' });
        const data = await res.json();
        if (!data.ok) throw new Error(data.error || 'server_error');
        const comments = normalizeCommentTree(data.comments || []);
        postCommentsCache.set(postId, comments);
        hydratedCommentThreads.add(postId);
        updateCommentCount(postId, data.total ?? comments.length);
        renderComments(postId);
      } catch (e) {
        alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏: ' + e.message);
        postCommentsCache.set(postId, []);
        hydratedCommentThreads.delete(postId);
        renderComments(postId);
      } finally {
        postCommentsLoading.delete(postId);
      }
    }

    async function toggleLike(postId, btn){
      try {
        btn.disabled = true;
        const res = await fetch(`/posts/${postId}/like`, { method:'POST', credentials:'include' });
        const data = await res.json();
        if (!res.ok || !data.ok) throw new Error(data.error || 'server_error');
        const post = findPost(postId);
        if (post){
          post.likes = data.likes;
          post.liked = data.liked;
        }
        btn.classList.toggle('active', !!data.liked);
        btn.dataset.liked = data.liked ? '1' : '0';
        const count = btn.querySelector('.count');
        if (count) count.textContent = data.likes;
      } catch (e) {
        alert('–û—à–∏–±–∫–∞: ' + e.message);
      } finally {
        btn.disabled = false;
      }
    }

    async function submitComment(postId, text, form){
      let success = false;
      try {
        const submitBtn = form.querySelector('button[type="submit"]') || form.querySelector('button');
        if (submitBtn) submitBtn.disabled = true;
        const parentIdAttr = form.dataset.parentId;
        const parentId = parentIdAttr ? parseInt(parentIdAttr, 10) : null;
        const res = await fetch(`/posts/${postId}/comments`, {
          method:'POST',
          credentials:'include',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ text, parent_id: parentId }),
        });
        const data = await res.json();
        if (!data.ok) throw new Error(data.error || 'server_error');
        const comment = data.comment;
        const total = data.total;
        if (comment){
          comment.parent_id = comment.parent_id ?? parentId ?? null;
          comment.post_id = comment.post_id ?? postId;
          const newNode = prepareCommentNode(comment);
          const existing = postCommentsCache.get(postId) || [];
          if (newNode.parent_id) {
            const parent = findCommentInTree(existing, newNode.parent_id);
            if (parent){
              parent.replies.push(newNode);
            } else {
              existing.push(newNode);
            }
          } else {
            existing.push(newNode);
          }
          postCommentsCache.set(postId, existing);
          renderComments(postId);
        }
        hydratedCommentThreads.add(postId);
        updateCommentCount(postId, total, 1);
        success = true;
      } catch (e) {
        alert('–û—à–∏–±–∫–∞: ' + e.message);
      } finally {
        const submitBtn = form.querySelector('button[type="submit"]') || form.querySelector('button');
        if (submitBtn) submitBtn.disabled = false;
        if (success) {
          form.reset();
          if (form.classList.contains('reply')) form.hidden = true;
        }
      }
      return success;
    }

    async function saveInfo(){
      const about = document.getElementById('about-edit').value;
      const interests = document.getElementById('interests-edit').value;
      try{
        const res = await fetch('/profile/me/info', { method:'PATCH', credentials:'include', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ about, interests }) });
        const data = await res.json();
        if (!data.ok) throw new Error(data.error||'server_error');
        // refresh view
        document.getElementById('p-about').textContent = data.about||'‚Äî';
        const wrap=document.getElementById('p-interests'); wrap.innerHTML='';
        (data.interests||'').split(',').map(s=>s.trim()).filter(Boolean).forEach(tag=>{ const t=document.createElement('span'); t.className='chip'; t.textContent=tag; wrap.appendChild(t); });
        document.getElementById('edit-row').style.display='none';
      }catch(e){ alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: '+e.message); }
    }

    function initComposer(){
      const card = document.getElementById('composer-card');
      if (!card) return;

      const textarea = card.querySelector('#post-text');
      const photoInput = card.querySelector('#post-photo');
      const pollQuestion = card.querySelector('#poll-question');
      const pollOptions = card.querySelector('#poll-options');
      const pollAnon = card.querySelector('#poll-anon');
      const submitBtn = card.querySelector('#composer-submit');
      const tools = Array.from(card.querySelectorAll('.composer-tool'));
      const uploadBlock = card.querySelector('#composer-upload');
      const pollBlock = card.querySelector('#composer-poll');
      const autoResize = () => {
        if (!textarea) return;
        textarea.style.height = 'auto';
        const next = Math.min(200, Math.max(44, textarea.scrollHeight));
        textarea.style.height = next + 'px';
      };
      if (textarea) {
        textarea.addEventListener('input', autoResize);
      }

      let currentMode = 'post';

      const setMode = (mode) => {
        currentMode = mode;
        tools.forEach(btn => btn.classList.toggle('active', btn.dataset.mode === mode));
        if (uploadBlock) uploadBlock.style.display = mode === 'photo' ? 'flex' : 'none';
        if (pollBlock) pollBlock.style.display = mode === 'poll' ? 'flex' : 'none';
        if (textarea) {
          textarea.placeholder = mode === 'photo'
            ? '–î–æ–±–∞–≤—å—Ç–µ –ø–æ–¥–ø–∏—Å—å –∫ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏'
            : mode === 'poll'
              ? '–û–ø–∏—à–∏—Ç–µ –≤–∞—à –≤–æ–ø—Ä–æ—Å'
            : '–ß—Ç–æ —É –≤–∞—Å –Ω–æ–≤–æ–≥–æ?';
          autoResize();
        }
      };

      tools.forEach(btn => btn.addEventListener('click', () => setMode(btn.dataset.mode || 'post')));

      submitBtn.addEventListener('click', async () => {
        if (submitBtn.disabled) return;
        const baseText = textarea.value.trim();
        let payload = {
          kind: currentMode,
          text: baseText,
          attachments: [],
          poll: null,
        };

        try {
          submitBtn.disabled = true;

          if (currentMode === 'post') {
            if (!payload.text) throw new Error('–ù–∞–ø–∏—à–∏—Ç–µ —á—Ç–æ-–Ω–∏–±—É–¥—å –¥–ª—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏.');
          } else if (currentMode === 'photo') {
            const files = Array.from(photoInput.files || []);
            if (!files.length) throw new Error('–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é.');
            const form = new FormData();
            files.forEach(file => form.append('photos', file));
            const uploadRes = await fetch('/me/photos', { method: 'POST', credentials: 'include', body: form });
            const uploadData = await uploadRes.json();
            if (!uploadRes.ok || !uploadData.ok) throw new Error(uploadData.error || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ñ–æ—Ç–æ');
            const uploaded = Array.isArray(uploadData.photos) ? uploadData.photos : [];
            if (!uploaded.length) throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ñ–æ—Ç–æ');
            payload.attachments = uploaded.map(p => p.path);
            if (!payload.text) payload.text = '–ü–æ–¥–µ–ª–∏–ª—Å—è —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–µ–π';
            if (currentProfile?.id) await loadPhotosPreview(currentProfile.id);
          } else if (currentMode === 'poll') {
            const question = pollQuestion.value.trim();
            const options = pollOptions.value.split('\n').map(s => s.trim()).filter(Boolean);
            if (!question || options.length < 2) throw new Error('–í–≤–µ–¥–∏—Ç–µ –≤–æ–ø—Ä–æ—Å –∏ –º–∏–Ω–∏–º—É–º –¥–≤–∞ –≤–∞—Ä–∏–∞–Ω—Ç–∞ –æ—Ç–≤–µ—Ç–æ–≤.');
            payload.poll = { question: question.slice(0, 200), options: options.slice(0, 10), anonymous: pollAnon.checked };
            if (!payload.text) payload.text = question;
          }

          if (currentMode !== 'photo') payload.attachments = [];
          if (currentMode !== 'poll') payload.poll = null;
          payload.text = (payload.text || '').toString().trim().slice(0, 700);

          const res = await fetch('/posts', {
            method: 'POST',
            credentials: 'include',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
          });
          const data = await res.json();
          if (!res.ok || !data.ok) throw new Error(data.error || 'server_error');
          const created = data.post ? {
            id: data.post.id,
            user_id: data.post.user_id,
            kind: data.post.kind || payload.kind,
            text: data.post.text || payload.text || '',
            attachments: Array.isArray(data.post.attachments) ? data.post.attachments : payload.attachments,
            poll: data.post.poll || payload.poll,
            created_at: data.post.created_at || new Date().toISOString(),
          } : null;
          if (created) {
            if (typeof created.likes !== 'number') created.likes = 0;
            if (typeof created.comments !== 'number') created.comments = 0;
            created.liked = !!created.liked;
            profilePosts.unshift(created);
            postCommentsCache.set(created.id, []);
            hydratedCommentThreads.delete(created.id);
          } else {
            await loadPosts(currentProfile.id, true);
          }

          if (currentProfile) {
            currentProfile.counters = currentProfile.counters || {};
            currentProfile.counters.posts = (currentProfile.counters.posts || 0) + 1;
            const postsCounter = document.getElementById('c-posts');
            if (postsCounter) postsCounter.textContent = currentProfile.counters.posts;
          }

          profilePostsLoading = false;
          renderProfileFeed();

          textarea.value = '';
          photoInput.value = '';
          pollQuestion.value = '';
          pollOptions.value = '';
          pollAnon.checked = false;
          setMode('post');
          autoResize();
        } catch (err) {
          alert(err.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –ø–æ—Å—Ç');
        } finally {
          submitBtn.disabled = false;
        }
      });

      textarea.addEventListener('keydown', (e)=>{
        if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
          e.preventDefault();
          submitBtn.click();
        }
      });

      setMode(currentMode);
      autoResize();
    }

    // Lightbox simple
    function openLightbox(src){ const lb=document.getElementById('lightbox'); const im=lb.querySelector('img'); im.src=src; lb.classList.add('open'); }
    function closeLightbox(){ document.getElementById('lightbox').classList.remove('open'); }

    document.addEventListener('DOMContentLoaded', ()=>{
      loadProfile();
      initComposer();
      document.getElementById('save-info').addEventListener('click', saveInfo);
      document.getElementById('cancel-info').addEventListener('click', ()=>{ document.getElementById('edit-row').style.display='none'; });
      const feedGrid = document.getElementById('profile-feed-grid');
      if (feedGrid){
        feedGrid.addEventListener('click', async (e)=>{
          const likeBtn = e.target.closest('.profile-feed-action.like');
          if (likeBtn){
            e.preventDefault();
            const postId = parseInt(likeBtn.dataset.postId, 10);
            if (Number.isInteger(postId)) await toggleLike(postId, likeBtn);
            return;
          }

          const commentsBtn = e.target.closest('.profile-feed-action.comment');
        if (commentsBtn){
          e.preventDefault();
          const postId = parseInt(commentsBtn.dataset.postId, 10);
          if (!Number.isInteger(postId)) return;
          const section = document.querySelector(`.profile-feed-comments[data-post-id="${postId}"]`);
          if (!section) return;
          const willShow = section.hidden;
          if (willShow){
            await ensureComments(postId);
            section.hidden = false;
            section.style.display = 'flex';
            commentsBtn.classList.add('open');
          } else {
            section.hidden = true;
            section.style.display = 'none';
            commentsBtn.classList.remove('open');
            section.querySelectorAll('.profile-feed-comment-reply-slot').forEach(slot => slot.innerHTML = '');
          }
          return;
        }

          const replyBtn = e.target.closest('.profile-feed-comment-reply');
          if (replyBtn){
            e.preventDefault();
            const commentId = parseInt(replyBtn.dataset.commentId, 10);
            if (!Number.isInteger(commentId)) return;
          const wrapper = replyBtn.closest('.profile-feed-comment-wrapper');
          if (!wrapper) return;
          const postId = parseInt(wrapper.dataset.postId || wrapper.closest('.profile-feed-comments')?.dataset.postId, 10);
          if (!Number.isInteger(postId)) return;
          const slot = wrapper.querySelector(`.profile-feed-comment-reply-slot[data-comment-id="${commentId}"]`);
          if (!slot) return;
          let form = slot.querySelector('form.profile-feed-comment-form');
          if (!form){
            form = createReplyForm(postId, commentId);
            slot.appendChild(form);
          }
          form.hidden = !form.hidden;
          if (!form.hidden){
            const input = form.querySelector('input[name="comment"]');
            if (input) input.focus();
          }
            return;
          }

          const toggleReplies = e.target.closest('.profile-feed-comment-toggle');
          if (toggleReplies){
            e.preventDefault();
            const commentId = parseInt(toggleReplies.dataset.commentId, 10);
            const postId = parseInt(toggleReplies.dataset.postId, 10);
            if (!Number.isInteger(commentId) || !Number.isInteger(postId)) return;
            const wrapper = toggleReplies.closest('.profile-feed-comment-wrapper');
            if (!wrapper) return;
            const thread = wrapper.querySelector(`.profile-feed-comment-thread[data-comment-id="${commentId}"]`);
            if (!thread) return;
            const state = toggleReplies.dataset.state === 'hidden';
            toggleReplies.dataset.state = state ? 'shown' : 'hidden';
            if (state) {
              toggleReplies.dataset.label = toggleReplies.textContent;
              toggleReplies.textContent = '–°–∫—Ä—ã—Ç—å –æ—Ç–≤–µ—Ç—ã';
            } else {
              const label = toggleReplies.dataset.label;
              if (label) toggleReplies.textContent = label;
            }
            thread.hidden = !state;
            thread.style.display = state ? 'flex' : 'none';
            if (state){
              // ensure replies exist if collapsed not loaded
              const existing = postCommentsCache.get(postId) || [];
              const parent = findCommentInTree(existing, commentId);
              if (!parent || !Array.isArray(parent.replies) || !parent.replies.length){
                // should not happen, but fallback to reload
                await ensureComments(postId);
              }
            }
            return;
          }
        });

        feedGrid.addEventListener('submit', async (e)=>{
          const form = e.target.closest('.profile-feed-comment-form');
          if (!form) return;
          e.preventDefault();
          const postId = parseInt(form.dataset.postId, 10);
          if (!Number.isInteger(postId)) return;
          const input = form.querySelector('input[name="comment"]');
          const text = input.value.trim();
          if (!text) return;
          await submitComment(postId, text, form);
        });
      }
      document.body.addEventListener('click', (e)=>{
        const ava = e.target.closest('#p-ava'); if (ava && ava.src) { openLightbox(ava.src); }
        const thumb = e.target.closest('#photos-preview img'); if (thumb) { openLightbox(thumb.src); }
        if (e.target.closest('.lightbox .close')) closeLightbox();
        if (e.target.classList.contains('lightbox')) closeLightbox();
      });
    });
  </script>
  <div id="lightbox" class="lightbox"><span class="close">‚úï</span><img src="" alt="preview"/></div>
</body>
</html>
