<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–ü—Ä–æ—Ñ–∏–ª—å ‚Äî TwinSide</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
</head>
<body>
  <div id="app-content">
    <!-- Top combined block: left photo+premium+gifts+album, right info -->
    <section class="profile-top">
      <div class="profile-photo-card">
        <img id="p-ava" class="profile-avatar" src="/assets/icons/user.svg" alt="avatar"/>
        <div id="premium-label" class="badge" style="margin-top:12px; display:inline-block">‚Äî</div>
        <h4>–ü–æ–¥–∞—Ä–∫–∏</h4>
        <div class="gift-row" id="gifts-row"></div>
        <h4>–ê–ª—å–±–æ–º</h4>
        <div class="thumbs mini" id="photos-preview"></div>
        <a id="photos-link" href="/app/photos" class="link" style="display:inline-block; margin-top:8px">–í—Å–µ —Ñ–æ—Ç–æ</a>
      </div>
      <div class="profile-info-card">
        <h1 id="p-nick" class="profile-name">‚Äî</h1>
        <div id="p-meta" class="profile-meta">‚Äî</div>
        <div id="online" class="profile-meta">‚Äî</div>
        <div class="badges" id="p-badges"></div>
        <div class="counters">
          <div class="counter"><b id="c-friends">0</b><span>–î—Ä—É–∑—å—è</span></div>
          <div class="counter"><b id="c-photos">0</b><span>–§–æ—Ç–æ</span></div>
          <div class="counter"><b id="c-posts">0</b><span>–ü–æ—Å—Ç—ã</span></div>
        </div>

        <section class="profile-section" style="margin-top:12px">
          <h3>–û —Å–µ–±–µ</h3>
          <p id="p-about">‚Äî</p>
          <div id="edit-row" style="margin-top:8px; display:none">
            <textarea id="about-edit" placeholder="–û —Å–µ–±–µ" maxlength="300" style="width:100%; min-height:80px; background:#0b0b0d; color:#fff; border:1px solid #1c1c22; border-radius:8px; padding:8px;"></textarea>
            <div class="row">
              <input id="interests-edit" placeholder="–ò–Ω—Ç–µ—Ä–µ—Å—ã —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é" style="flex:1; background:#0b0b0d; color:#fff; border:1px solid #1c1c22; border-radius:8px; padding:8px" />
              <button id="save-info" class="btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
              <button id="cancel-info" class="btn ghost">–û—Ç–º–µ–Ω–∞</button>
            </div>
          </div>
        </section>

        <section class="profile-section">
          <h3>–ò–Ω—Ç–µ—Ä–µ—Å—ã</h3>
          <div id="p-interests" class="chips"></div>
          <div style="margin-top:8px" id="who-looking"></div>
        </section>

        <div id="p-actions" style="margin-top:10px;display:flex;gap:8px"></div>
      </div>
    </section>

    <!-- Bottom: left friends, right composer -->
    <section class="profile-bottom" id="profile-bottom">
      <div class="profile-friends-card">
        <div class="header">
          <h3>–î—Ä—É–∑—å—è</h3>
          <a href="/app/friends">–í—Å–µ</a>
        </div>
        <div class="friends-row" id="friends-preview"></div>
      </div>
      <div class="profile-composer-card" id="composer-card" style="display:none">
        <h3>–ü–æ–¥–µ–ª–∏—Ç—å—Å—è</h3>
        <div class="composer-tabs">
          <button class="active" data-mode="post">–ü–æ—Å—Ç</button>
          <button data-mode="photo">–§–æ—Ç–æ</button>
          <button data-mode="poll">–û–ø—Ä–æ—Å</button>
        </div>
        <div class="composer-body">
          <textarea id="post-text" placeholder="–ß—Ç–æ —É –≤–∞—Å –Ω–æ–≤–æ–≥–æ?"></textarea>
          <div class="composer-upload" id="composer-upload">
            <input id="post-photo" type="file" accept="image/*" multiple />
            <span class="composer-description">–ú–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –¥–æ 10 —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π</span>
          </div>
          <div class="composer-poll" id="composer-poll" style="display:none">
            <input type="text" id="poll-question" placeholder="–í–æ–ø—Ä–æ—Å" style="width:100%; background:#0b0b0d; color:#fff; border:1px solid #1c1c22; border-radius:8px; padding:8px; margin-bottom:8px;" />
            <textarea id="poll-options" placeholder="–í–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–∞, –∫–∞–∂–¥—ã–π —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏" style="width:100%; min-height:80px; background:#0b0b0d; color:#fff; border:1px solid #1c1c22; border-radius:8px; padding:8px;"></textarea>
            <label style="display:flex; align-items:center; gap:6px; margin-top:6px; font-size:13px; color:#cfcfe2;">
              <input type="checkbox" id="poll-anon" /> –ê–Ω–æ–Ω–∏–º–Ω–æ–µ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ
            </label>
          </div>
          <div class="composer-actions">
            <button class="btn ghost" id="composer-cancel" type="button">–û—Ç–º–µ–Ω–∞</button>
            <button class="btn" id="composer-submit" type="button">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
          </div>
        </div>
      </div>
    </section>
    
  </div>

  <script src="/app/js/app-shell.js" defer></script>
  <link rel="stylesheet" href="/assets/app.css?v=profile3" />
  <script>
    async function loadProfile(){
      const params = new URLSearchParams(window.location.search);
      const userId = params.get('id');
      try {
        if (userId) {
          const r = await fetch(`/users/${userId}/profile`);
          const data = await r.json();
          if (!data.ok) throw new Error(data.error||'not_found');
          render(data.profile, false);
          loadFriendsPreview(parseInt(userId,10), false);
          loadPhotosPreview(parseInt(userId,10));
        } else {
          const r = await fetch('/me/overview', { credentials:'include' });
          const me = await r.json();
          if (!me.ok) { window.location.href='/public/auth'; return; }
          render(me.profile, true);
          loadFriendsPreview(me.profile.id, true);
          loadPhotosPreview(me.profile.id);
        }
      } catch(e){
        document.getElementById('app-content').innerHTML = `<div class=\"table-message\">–û—à–∏–±–∫–∞: ${e.message}</div>`;
      }
    }

    function render(p, isMe){
      if (p.avatar) document.getElementById('p-ava').src = p.avatar;
      const name = `${p.nick||'‚Äî'} ${p.premium?'üëë':''}`;
      document.getElementById('p-nick').textContent = name;
      const agePart = p.age ? ` ¬∑ ${p.age}` : '';
      document.getElementById('p-meta').textContent = `${p.city||'–ì–æ—Ä–æ–¥ –Ω–µ —É–∫–∞–∑–∞–Ω'} ¬∑ ${p.gender||'‚Äî'}${agePart}`;
      // online/offline
      const onlineEl = document.getElementById('online');
      const last = p.last_active ? new Date(p.last_active) : null;
      const online = last ? (Date.now() - last.getTime() < 5*60*1000) : false;
      onlineEl.textContent = online ? '–û–Ω–ª–∞–π–Ω' : (last ? `–ë—ã–ª(–∞) –≤ —Å–µ—Ç–∏: ${last.toLocaleString('ru-RU')}` : '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏');
      document.getElementById('p-about').textContent = p.about || '‚Äî';
      const interestsWrap = document.getElementById('p-interests');
      interestsWrap.innerHTML = '';
      const interests = (p.interests||'').split(',').map(s=>s.trim()).filter(Boolean);
      if (interests.length===0) interestsWrap.innerHTML = '<span class="chip">‚Äî</span>';
      interests.forEach(tag=>{ const t=document.createElement('span'); t.className='chip'; t.textContent=tag; interestsWrap.appendChild(t); });

      if (p.counters){
        document.getElementById('c-friends').textContent = p.counters.friends||0;
        document.getElementById('c-photos').textContent = p.counters.photos||0;
        document.getElementById('c-posts').textContent = p.counters.posts||0;
      }

      const whoWrap = document.getElementById('who-looking');
      const who = p.gender==='man'?'–û–Ω': p.gender==='woman'?'–û–Ω–∞': p.gender==='pair'?'–ü–∞—Ä–∞': '‚Äî';
      const looking = (p.looking_for||'').split(',').map(s=>s.trim()).filter(Boolean).join(', ');
      whoWrap.textContent = `${who} ¬∑ –ò—â–µ—Ç: ${looking||'‚Äî'}`;

      const actions = document.getElementById('p-actions');
      actions.innerHTML = '';
      const composerCard = document.getElementById('composer-card');
      if (composerCard) composerCard.style.display = isMe ? 'block' : 'none';
      const bottomSection = document.getElementById('profile-bottom');
      if (bottomSection) bottomSection.classList.toggle('single', !isMe);
      if (isMe) {
        const a2 = document.createElement('button'); a2.className='btn'; a2.textContent='–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å'; a2.onclick=enableEdit; actions.appendChild(a2);
        const a1 = document.createElement('a'); a1.className='btn ghost'; a1.href='/app/wallet'; a1.textContent='–ö–æ—à–µ–ª—ë–∫'; actions.appendChild(a1);
      } else {
        const m = document.createElement('button'); m.className='btn'; m.textContent='–ù–∞–ø–∏—Å–∞—Ç—å'; actions.appendChild(m);
        const f = document.createElement('button'); f.className='btn'; f.textContent='–í –¥—Ä—É–∑—å—è'; f.addEventListener('click', ()=>friend(p.id)); actions.appendChild(f);
        const r = document.createElement('button'); r.className='btn ghost'; r.textContent='–ü–æ–∂–∞–ª–æ–≤–∞—Ç—å—Å—è'; actions.appendChild(r);
      }

      // premium label
      const prem = document.getElementById('premium-label');
      const prefLabel = p.premium ? '–ü—Ä–µ–º–∏—É–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å' : '–û–±—ã—á–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
      prem.textContent = prefLabel;
      prem.className = `premium-badge ${p.premium ? 'premium' : 'basic'}`;

      const giftsRow = document.getElementById('gifts-row');
      if (giftsRow) {
        giftsRow.innerHTML = '';
        const empty = document.createElement('span');
        empty.className = 'gift empty';
        empty.textContent = '–ü–æ–¥–∞—Ä–∫–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç';
        giftsRow.appendChild(empty);
      }

      const photosLink = document.getElementById('photos-link');
      if (photosLink) photosLink.textContent = `–í—Å–µ —Ñ–æ—Ç–æ (${p.counters?.photos ?? 0})`;
    }

    async function friend(id){
      try {
        const res = await fetch(`/friends/${id}`, { method:'POST', credentials:'include' });
        const data = await res.json();
        if (!data.ok) throw new Error(data.error||'server_error');
        alert(data.accepted ? '–ó–∞—è–≤–∫–∞ –ø—Ä–∏–Ω—è—Ç–∞' : '–ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞');
      } catch(e){ alert('–û—à–∏–±–∫–∞: '+e.message); }
    }

    async function loadFriendsPreview(userId, isMe){
      const wrap = document.getElementById('friends-preview');
      wrap.innerHTML = '';
      try{
        if (isMe){
          const fr = await (await fetch('/friends', { credentials:'include' })).json();
          (fr.friends||[]).slice(0,6).forEach(u=>{
            const a=document.createElement('a'); a.href='/app/profile?id='+u.id; a.title=u.nick||'';
            const img=document.createElement('img'); img.src=u.avatar||'/assets/icons/user.svg'; a.appendChild(img); wrap.appendChild(a);
          });
        } else {
          const pr = await (await fetch(`/users/${userId}/friends-preview`)).json();
          (pr.friends||[]).slice(0,6).forEach(u=>{ const a=document.createElement('a'); a.href='/app/profile?id='+u.id; const img=document.createElement('img'); img.src=u.avatar||'/assets/icons/user.svg'; a.appendChild(img); wrap.appendChild(a); });
        }
      }catch{}
      if (!wrap.children.length) wrap.innerHTML = '<div class="thumbs-empty">–ù–µ—Ç –¥—Ä—É–∑–µ–π</div>';
    }

    async function loadPhotosPreview(userId){
      const wrap = document.getElementById('photos-preview');
      wrap.innerHTML='';
      try{
        const res = await (await fetch(`/users/${userId}/photos?limit=6`)).json();
        if (res.ok){
          if (!res.photos.length) wrap.innerHTML='<div class="thumbs-empty">–ù–µ—Ç —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π</div>';
          res.photos.slice(0,6).forEach(p=>{ const img=document.createElement('img'); img.src=p.path; img.alt="photo"; img.addEventListener('click', ()=>openLightbox(p.path)); wrap.appendChild(img); });
        } else {
          wrap.innerHTML='<div class="thumbs-empty">–ù–µ—Ç —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π</div>';
        }
      }catch{ wrap.innerHTML='<div class="thumbs-empty">–ù–µ—Ç —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π</div>'; }
      const link = document.getElementById('photos-link');
      link.href = '/app/photos?id='+userId;
    }

    function enableEdit(){
      const box = document.getElementById('edit-row');
      box.style.display='block';
      document.getElementById('about-edit').value = document.getElementById('p-about').textContent;
      document.getElementById('interests-edit').value = (Array.from(document.querySelectorAll('#p-interests .chip')).map(el=>el.textContent).join(', '));
    }

    async function saveInfo(){
      const about = document.getElementById('about-edit').value;
      const interests = document.getElementById('interests-edit').value;
      try{
        const res = await fetch('/profile/me/info', { method:'PATCH', credentials:'include', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ about, interests }) });
        const data = await res.json();
        if (!data.ok) throw new Error(data.error||'server_error');
        // refresh view
        document.getElementById('p-about').textContent = data.about||'‚Äî';
        const wrap=document.getElementById('p-interests'); wrap.innerHTML='';
        (data.interests||'').split(',').map(s=>s.trim()).filter(Boolean).forEach(tag=>{ const t=document.createElement('span'); t.className='chip'; t.textContent=tag; wrap.appendChild(t); });
        document.getElementById('edit-row').style.display='none';
      }catch(e){ alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: '+e.message); }
    }

    function initComposer(){
      const card = document.getElementById('composer-card');
      if (!card) return;
      const tabs = card.querySelectorAll('.composer-tabs button');
      const uploadBlock = card.querySelector('#composer-upload');
      const pollBlock = card.querySelector('#composer-poll');
      const textarea = card.querySelector('#post-text');
      const photoInput = card.querySelector('#post-photo');
      const pollQuestion = card.querySelector('#poll-question');
      const pollOptions = card.querySelector('#poll-options');
      const pollAnon = card.querySelector('#poll-anon');
      const cancelBtn = card.querySelector('#composer-cancel');
      const submitBtn = card.querySelector('#composer-submit');

      const setMode = (mode) => {
        tabs.forEach(btn => btn.classList.toggle('active', btn.dataset.mode === mode));
        if (mode === 'post') {
          uploadBlock.style.display = 'none';
          pollBlock.style.display = 'none';
        } else if (mode === 'photo') {
          uploadBlock.style.display = 'flex';
          pollBlock.style.display = 'none';
        } else if (mode === 'poll') {
          uploadBlock.style.display = 'none';
          pollBlock.style.display = 'block';
        }
      };

      tabs.forEach(btn => btn.addEventListener('click', () => setMode(btn.dataset.mode)));
      cancelBtn.addEventListener('click', () => {
        textarea.value = '';
        photoInput.value = '';
        pollQuestion.value = '';
        pollOptions.value = '';
        pollAnon.checked = false;
        setMode('post');
      });
      submitBtn.addEventListener('click', () => {
        alert('–ü—É–±–ª–∏–∫–∞—Ü–∏—è –ø–æ—è–≤–∏—Ç—Å—è –≤ —Å–ª–µ–¥—É—é—â–∏—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è—Ö.');
      });
      setMode('post');
    }

    // Lightbox simple
    function openLightbox(src){ const lb=document.getElementById('lightbox'); const im=lb.querySelector('img'); im.src=src; lb.classList.add('open'); }
    function closeLightbox(){ document.getElementById('lightbox').classList.remove('open'); }

    document.addEventListener('DOMContentLoaded', ()=>{
      loadProfile();
      initComposer();
      document.getElementById('save-info').addEventListener('click', saveInfo);
      document.getElementById('cancel-info').addEventListener('click', ()=>{ document.getElementById('edit-row').style.display='none'; });
      document.body.addEventListener('click', (e)=>{
        const ava = e.target.closest('#p-ava'); if (ava && ava.src) { openLightbox(ava.src); }
        const thumb = e.target.closest('#photos-preview img'); if (thumb) { openLightbox(thumb.src); }
        if (e.target.closest('.lightbox .close')) closeLightbox();
        if (e.target.classList.contains('lightbox')) closeLightbox();
      });
    });
  </script>
  <div id="lightbox" class="lightbox"><span class="close">‚úï</span><img src="" alt="preview"/></div>
</body>
</html>
